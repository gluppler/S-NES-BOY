# 1.5 ROM Fundamentals

## System Applicability

**This document applies to:**
- ✅ **NES**: Primary focus (cartridge-based ROM)
- ✅ **Famicom**: Fully compatible (same cartridge format, plus Famicom Disk System support)
- ❌ **SNES**: Does not apply (different ROM format and header structure)

**Famicom-Specific Notes:**
- Famicom supports **Famicom Disk System (FDS)** in addition to cartridges
- FDS uses disk-based storage (64 KB RAM, battery-backed saves)
- Famicom cartridges are identical to NES cartridges (same iNES format)
- Some Famicom games use expansion audio (additional sound channels)

## Physical Hardware Overview

NES and Famicom cartridges contain:

* **PRG ROM**: Program ROM, contains CPU-executable code and data
* **CHR ROM**: Character ROM, contains PPU pattern table data (tiles)
* **Optional CHR RAM**: Writable CHR memory (rare, requires battery)
* **Optional PRG RAM**: Battery-backed save RAM ($6000–$7FFF)
* **Mapper hardware**: Logic that remaps ROM banks to CPU/PPU address space
* **iNES header**: 16-byte metadata at start of ROM file

The simplest cartridge uses **Mapper 0 (NROM)**, which provides fixed or mirrored PRG/CHR banks with no bank switching.

## NES/Famicom Terminology Definitions

* **iNES Header**: 16-byte header format defining ROM structure
* **PRG ROM**: Program ROM, mapped to CPU address space ($8000–$FFFF)
* **CHR ROM**: Character ROM, mapped to PPU address space ($0000–$1FFF)
* **Mapper**: Cartridge hardware that performs bank switching
* **Mapper 0 (NROM)**: Simplest mapper, no bank switching
* **Bank**: Contiguous block of ROM (typically 8 KB PRG, 8 KB CHR)
* **Mirroring**: Duplicating ROM banks to fill address space

## Core Rules and Invariants

### iNES Header

The iNES header (16 bytes) structure:

| Offset | Size | Description |
|--------|------|-------------|
| 0–3 | 4 | Magic: "NES" + $1A |
| 4 | 1 | PRG ROM size (16 KB units) |
| 5 | 1 | CHR ROM size (8 KB units, 0 = CHR RAM) |
| 6 | 1 | Flags 6: Mapper low, mirroring, battery, trainer |
| 7 | 1 | Flags 7: Mapper high, VS/Playchoice, NES 2.0 |
| 8 | 1 | PRG RAM size (8 KB units, rarely used) |
| 9 | 1 | TV system (0=NTSC, 1=PAL) |
| 10 | 6 | Unused (should be 0) |

Key flags in byte 6:
* Bit 0: Mirroring (0=horizontal, 1=vertical)
* Bit 1: Battery-backed PRG RAM
* Bit 2: Trainer present (512 bytes before PRG ROM)
* Bit 3: Ignore mirroring (use 4-screen VRAM)
* Bits 4–7: Mapper number (low 4 bits)

### PRG ROM vs CHR ROM

* **PRG ROM**: Contains CPU code/data, mapped to $8000–$FFFF
  - Typical sizes: 16 KB, 32 KB, 128 KB, 256 KB, 512 KB
  - If 16 KB: mirrored to both $8000–$BFFF and $C000–$FFFF
  - If 32 KB: $8000–$FFFF (no mirroring)
* **CHR ROM**: Contains PPU pattern data, mapped to $0000–$1FFF
  - Typical sizes: 8 KB, 16 KB, 32 KB, 128 KB
  - Always 8 KB visible at once (pattern tables 0 and 1)

### Mapper 0 (NROM) Mental Model

Mapper 0 is the simplest mapper:

* **16 KB PRG**: 
  - Bank at $8000–$BFFF
  - Same bank mirrored at $C000–$FFFF
* **32 KB PRG**:
  - Bank at $8000–$FFFF (no mirroring)
* **8 KB CHR**:
  - Fixed at $0000–$1FFF
* **16 KB CHR**:
  - First 8 KB at $0000–$0FFF
  - Second 8 KB at $1000–$1FFF
* **No bank switching**: ROM is fixed in address space

### ROM File Layout

```
[0x0000] iNES Header (16 bytes)
[0x0010] Trainer (512 bytes, if present)
[0x0210] PRG ROM (16 KB × PRG_SIZE)
[0x4210] CHR ROM (8 KB × CHR_SIZE, if CHR_SIZE > 0)
```

## Minimal Correct Usage Example

```asm
; iNES header for 32 KB PRG, 8 KB CHR, Mapper 0, horizontal mirroring
.segment "HEADER"
    .byte "NES", $1A    ; Magic
    .byte 2             ; 32 KB PRG (2 × 16 KB)
    .byte 1             ; 8 KB CHR (1 × 8 KB)
    .byte %00000000     ; Mapper 0, horizontal mirroring, no battery
    .byte %00000000     ; Mapper 0 (high), NES format
    .byte 0             ; PRG RAM size
    .byte 0             ; NTSC
    .byte 0, 0, 0, 0, 0, 0  ; Unused

; Reset vector points to reset handler
.segment "VECTORS"
    .addr nmi, reset, irq

; PRG ROM code
.segment "CODE"
reset:
    ; ... initialization ...

; CHR ROM data (tiles)
.segment "CHARS"
    .incbin "tiles.chr"
```

## Famicom Disk System (FDS)

**Famicom-specific feature** (not available on NES):

The Famicom Disk System uses disk-based storage instead of cartridges:
* **64 KB RAM**: Disk data loaded into RAM ($6000–$DFFF)
* **Battery-backed saves**: Save data stored on disk
* **Expansion audio**: Additional sound channels (waveform RAM)
* **Disk format**: Proprietary disk format (not iNES)

**Note**: FDS development requires Famicom hardware or FDS-compatible emulator. Most homebrew targets cartridge format (iNES) for broader compatibility.

## Explicit Non-Goals

This section does not cover:
* Advanced mappers (MMC1, MMC3, etc.)
* Bank switching techniques
* CHR RAM usage
* PRG RAM (save data) handling
* ROM file format details beyond iNES header
* Famicom Disk System disk format details

## Cross-References

- Related Fundamentals: 1.1 (System Overview), 1.3 (Memory), 1.4 (PPU)
- Related Advanced Fundamentals: None (ROM is static)
- Related Core Concepts: None (ROM is data, not a system)
- Related Cheatsheets: None (ROM format is tooling-specific)
