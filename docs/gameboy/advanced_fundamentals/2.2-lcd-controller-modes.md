# 2.2 LCD Controller Modes

## System Applicability

**This document applies to:**
- ✅ **Game Boy (DMG): Primary focus
- ✅ **Game Boy Color (CGB): Differences explicitly labeled

## Physical Hardware Overview

The Game Boy LCD controller operates in four distinct modes during each scanline:

* **Mode 0 (HBlank): Horizontal blanking period
* **Mode 1 (VBlank): Vertical blanking period
* **Mode 2 (OAM Search): Sprite evaluation
* **Mode 3 (Pixel Transfer): Active pixel rendering

These modes cycle continuously during frame rendering, with specific memory access restrictions for each mode.

## Game Boy Terminology Definitions

* **LCD Mode: Current PPU rendering state (0-3)
* **HBlank: Horizontal blanking (between scanlines)
* **VBlank: Vertical blanking (between frames)
* **OAM Search: Sprite evaluation phase
* **Pixel Transfer: Active pixel rendering phase
* **Scanline: One horizontal line of video (160 pixels)
* **Frame: Complete screen refresh (144 visible + 10 VBlank scanlines)

## Core Rules and Invariants

### LCD Mode Cycle

Per scanline (456 cycles total):
* **Mode 2 (OAM Search): 80 cycles
* **Mode 3 (Pixel Transfer): 172-289 cycles (varies)
* **Mode 0 (HBlank): Remaining cycles (87-204 cycles)

Per frame (154 scanlines total):
* **Scanlines 0-143: Visible rendering (Mode 2, 3, 0 cycle)
* **Scanline 144: VBlank starts (Mode 1)
* **Scanlines 144-153: VBlank (Mode 1, 4560 cycles total)

### Memory Access Restrictions

| Mode | VRAM Access | OAM Access | Notes |
|------|-------------|------------|-------|
| 0 (HBlank) | ✅ Allowed | ✅ Allowed | Safe for all access |
| 1 (VBlank) | ✅ Allowed | ✅ Allowed | Safe for all access |
| 2 (OAM Search) | ✅ Allowed | ❌ Locked | VRAM accessible, OAM locked |
| 3 (Pixel Transfer) | ❌ Locked | ❌ Locked | Both VRAM and OAM locked |

### Mode Detection

* **STAT Register ($FF41): Bits 0-1 indicate current mode
* **Mode Interrupt: Can trigger interrupt on mode change
* **LY Register ($FF44): Current scanline (0-153)

## Minimal Correct Usage Example

```asm
; Wait for VBlank (Mode 1)
wait_vblank:
    ld a, [rLY]
    cp 144
    jr c, wait_vblank
    ret

; Check LCD mode
check_mode:
    ld a, [rSTAT]
    and %00000011   ; Mode bits
    cp 1            ; VBlank?
    ret z
    ; Not VBlank
    ret
```

## Gold Standard Example

```asm
; Complete LCD mode handling example
SECTION "Code", ROM0[$0150]

; Wait for VBlank (Mode 1) - safe for VRAM/OAM access
wait_vblank:
    ; Per Pan Docs: VBlank starts at scanline 144
    ld a, [rLY]
    cp 144
    jr c, wait_vblank
    ret

; Wait for HBlank (Mode 0) - safe for VRAM/OAM access
wait_hblank:
    ; Per Pan Docs: Check STAT register for mode
    ld a, [rSTAT]
    and %00000011   ; Mode bits (0-3)
    cp 0            ; Mode 0 (HBlank)?
    jr nz, wait_hblank
    ret

; Safe VRAM access (only during Mode 0 or Mode 1)
safe_vram_write:
    ; Wait for safe mode
    call wait_vblank  ; Or wait_hblank
    
    ; Now safe to write to VRAM
    ld hl, $8000
    ld a, $FF
    ld [hl+], a
    
    ret

; Safe OAM access (only during Mode 0 or Mode 1)
safe_oam_write:
    ; Wait for safe mode
    call wait_vblank  ; Or wait_hblank
    
    ; Now safe to write to OAM
    ld hl, $FE00
    ld a, $10        ; Y position
    ld [hl+], a
    ld a, $08        ; X position
    ld [hl+], a
    ld a, $00        ; Tile number
    ld [hl+], a
    ld a, $00        ; Attributes
    ld [hl], a
    
    ret

; LCD STAT interrupt handler (mode change detection)
lcd_stat_handler:
    push af
    push hl
    
    ; Check which mode triggered interrupt
    ld a, [rSTAT]
    and %00000011   ; Mode bits
    
    cp 0            ; Mode 0 (HBlank)?
    jr z, .hblank
    
    cp 1            ; Mode 1 (VBlank)?
    jr z, .vblank
    
    cp 2            ; Mode 2 (OAM Search)?
    jr z, .oam_search
    
    ; Mode 3 (Pixel Transfer) - should not trigger interrupt
    jr .done
    
.hblank:
    ; HBlank processing
    ; Per Pan Docs: Safe to access VRAM/OAM
    jr .done
    
.vblank:
    ; VBlank processing
    ; Per Pan Docs: Safe to access VRAM/OAM
    jr .done
    
.oam_search:
    ; OAM Search processing
    ; Per Pan Docs: VRAM accessible, OAM locked
    jr .done
    
.done:
    pop hl
    pop af
    reti
```

## Validation Rules

### LCD Mode Requirements

1. **VRAM Access: Only during Mode 0 (HBlank) or Mode 1 (VBlank)
2. **OAM Access: Only during Mode 0 (HBlank) or Mode 1 (VBlank)
3. **Mode Detection: Use STAT register to check current mode
4. **VBlank Wait: Wait for scanline 144 for VBlank
5. **HBlank Wait: Check STAT register for Mode 0

### Failure Modes

* **VRAM Access During Mode 3: Causes corruption, incorrect tiles
* **OAM Access During Mode 2-3: Causes sprite glitches, corruption
* **Missing Mode Check: Accessing restricted memory causes undefined behavior
* **Incorrect VBlank Detection: Not waiting for actual VBlank causes corruption

## Cross-References

- Related Fundamentals: 1.1 (Game Boy System Overview), 1.3 (Memory Fundamentals)
- Related Advanced Fundamentals: 2.3 (Memory Access Restrictions), 2.4 (Interrupt System)
- Related Core Concepts: 3.2 (Rendering Pipeline)
