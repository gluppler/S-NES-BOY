# 2.4 Interrupt System

## System Applicability

**This document applies to:**
- ✅ **Game Boy (DMG): Primary focus
- ✅ **Game Boy Color (CGB): Differences explicitly labeled

## Physical Hardware Overview

The Game Boy has five interrupt sources:

* **VBlank: Fires at start of VBlank (scanline 144)
* **LCD STAT: Fires on LCD mode changes (configurable)
* **Timer: Fires when timer overflows
* **Serial: Fires when serial transfer completes
* **Joypad: Fires on button press (CGB only)

Interrupts are maskable via the IE register ($FFFF) and IME flag. When an interrupt fires, the CPU jumps to a fixed address (interrupt vector) and executes the interrupt handler.

## Game Boy Terminology Definitions

* **Interrupt: Hardware event that pauses main execution
* **Interrupt Vector: Fixed address where interrupt handler is located
* **IE Register: Interrupt Enable register ($FFFF)
* **IF Register: Interrupt Flag register ($FF0F)
* **IME Flag: Interrupt Master Enable (set by ei, cleared by di)
* **Interrupt Handler: Code that processes interrupt events
* **reti: Return from interrupt (enables interrupts)

## Core Rules and Invariants

### Interrupt Vectors

| Interrupt | Vector | Priority | Description |
|-----------|--------|----------|-------------|
| VBlank | $0040 | Highest | Frame synchronization |
| LCD STAT | $0048 | High | LCD mode changes |
| Timer | $0050 | Medium | Timer overflow |
| Serial | $0058 | Low | Serial transfer complete |
| Joypad | $0060 | Lowest | Button press (CGB only) |

### Interrupt Priority

When multiple interrupts are pending, they are serviced in priority order:
1. VBlank (highest)
2. LCD STAT
3. Timer
4. Serial
5. Joypad (lowest)

### Interrupt Enable

* **IE Register ($FFFF): Bits enable specific interrupts
* **IME Flag: Master enable (must be set with ei)
* **IF Register ($FF0F): Bits indicate pending interrupts
* **Interrupt Acknowledge: Reading IF register may clear flags (implementation-dependent)

## Minimal Correct Usage Example

```asm
SECTION "VBlank", ROM0[$0040]
    jp vblank_handler

vblank_handler:
    push af
    ; VBlank processing
    pop af
    reti
```

## Gold Standard Example

```asm
; Complete Game Boy interrupt system example
SECTION "VBlank", ROM0[$0040]
    jp vblank_handler

SECTION "LCD STAT", ROM0[$0048]
    jp lcd_stat_handler

SECTION "Timer", ROM0[$0050]
    jp timer_handler

SECTION "Serial", ROM0[$0058]
    jp serial_handler

SECTION "Joypad", ROM0[$0060]
    jp joypad_handler

SECTION "Code", ROM0[$0150]

; Initialize interrupts
init_interrupts:
    ; Disable interrupts during initialization
    di
    
    ; Clear interrupt flags
    xor a
    ld [rIF], a
    
    ; Enable desired interrupts
    ; Bit 0 = VBlank, Bit 1 = LCD STAT, Bit 2 = Timer, Bit 3 = Serial, Bit 4 = Joypad
    ld a, %00000001  ; VBlank only
    ld [rIE], a
    
    ; Enable interrupts
    ei
    
    ret

; VBlank interrupt handler
vblank_handler:
    ; Per Pan Docs: Must preserve all registers
    push af
    push bc
    push de
    push hl
    
    ; VBlank processing
    ; Per Pan Docs: Safe to access VRAM/OAM during VBlank
    call update_oam
    call update_scroll
    call frame_counter_inc
    
    ; Clear VBlank flag (if needed)
    ; Note: Some implementations clear flag automatically
    
    pop hl
    pop de
    pop bc
    pop af
    reti            ; Return and enable interrupts

; LCD STAT interrupt handler
lcd_stat_handler:
    push af
    push hl
    
    ; Check which mode triggered interrupt
    ld a, [rSTAT]
    and %00000011   ; Mode bits
    
    cp 0            ; Mode 0 (HBlank)?
    jr z, .hblank
    
    cp 1            ; Mode 1 (VBlank)?
    jr z, .vblank
    
    cp 2            ; Mode 2 (OAM Search)?
    jr z, .oam_search
    
    ; Mode 3 (Pixel Transfer)
    jr .done
    
.hblank:
    ; HBlank processing
    jr .done
    
.vblank:
    ; VBlank processing (usually handled by VBlank interrupt)
    jr .done
    
.oam_search:
    ; OAM Search processing
    jr .done
    
.done:
    pop hl
    pop af
    reti

; Timer interrupt handler
timer_handler:
    push af
    
    ; Timer processing
    call update_timer
    
    pop af
    reti

; Serial interrupt handler
serial_handler:
    push af
    
    ; Serial processing
    call handle_serial
    
    pop af
    reti

; Joypad interrupt handler (CGB only)
joypad_handler:
    push af
    
    ; Joypad processing
    call handle_joypad
    
    pop af
    reti
```

## Validation Rules

### Interrupt Requirements

1. **Register Preservation: Interrupt handlers must preserve all registers
2. **Interrupt Return: Must use reti (not ret) to re-enable interrupts
3. **Vector Setup: Interrupt vectors must contain jump instructions
4. **Flag Clearing: Interrupt flags may need manual clearing
5. **Nested Interrupts: Interrupts can interrupt other interrupts (priority-based)

### Failure Modes

* **Missing Register Save: Interrupt handler corrupts main program state
* **Wrong Return: Using ret instead of reti leaves interrupts disabled
* **Missing Vector: Interrupt fires but no handler exists (undefined behavior)
* **Flag Not Cleared: Interrupt fires repeatedly
* **Race Conditions: Data corruption from interrupt handlers

## Cross-References

- Related Fundamentals: 1.2 (LR35902 CPU Fundamentals), 1.5 (Execution Flow)
- Related Advanced Fundamentals: 2.2 (LCD Controller Modes)
- Related Core Concepts: 3.1 (The Game Loop)
