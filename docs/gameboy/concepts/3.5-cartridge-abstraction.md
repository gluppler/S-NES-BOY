# 3.5 Cartridge Abstraction

## System Applicability

**This document applies to:**
- ✅ **Game Boy (DMG): Primary focus
- ✅ **Game Boy Color (CGB): Differences explicitly labeled

## Concept Definition

Game Boy cartridges use Memory Bank Controllers (MBC) to extend the addressable ROM and RAM beyond the 64 KB CPU address space. The MBC handles bank switching, allowing access to larger ROM and optional RAM. This abstraction enables games larger than 32 KB ROM and provides save game functionality through battery-backed RAM.

Cartridge components:
* **ROM: Game code and data (32 KB to multiple MB)
* **MBC: Memory Bank Controller (handles bank switching)
* **RAM: Optional save game memory (battery-backed)
* **Header: Cartridge metadata (defines MBC type, ROM/RAM size)

## Subsystems Involved

* **CPU: Accesses ROM and RAM through MBC
* **MBC: Handles bank switching logic
* **ROM: Stores game code and data
* **RAM: Stores save game data (optional, battery-backed)
* **Cartridge Header: Defines cartridge configuration

## Step-by-Step Data Flow

1. **ROM Access:
   - CPU reads from $0000-$7FFF (ROM area)
   - MBC maps address to appropriate ROM bank
   - Bank 0 ($0000-$3FFF): Fixed, always accessible
   - Bank N ($4000-$7FFF): Switchable, controlled by MBC

2. **Bank Switching:
   - CPU writes to MBC registers ($0000-$7FFF, specific addresses)
   - MBC updates internal bank registers
   - Subsequent ROM reads use new bank
   - Bank switching takes effect immediately

3. **RAM Access (if present):
   - CPU reads/writes to $A000-$BFFF (RAM area)
   - MBC maps address to RAM bank
   - RAM must be enabled before access
   - Battery-backed RAM persists when cartridge removed

4. **Save Game:
   - Game writes data to RAM area
   - MBC handles RAM bank switching (if multiple banks)
   - Battery maintains RAM contents when powered off

## Timing Implications

* **Bank Switching: Immediate (takes effect on next access)
* **RAM Enable: Must enable before access
* **ROM Access: Same timing as normal memory access
* **RAM Access: Same timing as normal memory access (if enabled)

## Why This Pattern Exists on Game Boy Specifically

* **Address Space Limitation: 16-bit address bus limits to 64 KB
* **Game Size: Games need more than 32 KB ROM
* **Save Games: Battery-backed RAM enables persistent storage
* **Cost Efficiency: MBC chips provide bank switching at low cost
* **Flexibility: Different MBC types support different ROM/RAM sizes

## Failure Modes and Visible Symptoms

* **Wrong Bank Selected: Game reads incorrect ROM data
* **RAM Not Enabled: RAM writes have no effect
* **Bank Switching Errors: Game crashes or shows wrong data
* **Save Corruption: Battery failure causes save data loss

## Minimal Example

```asm
; Switch ROM bank (MBC1 example)
switch_rom_bank:
    ld a, 2         ; Bank number
    ld [$2000], a   ; MBC1 ROM bank register
    ret
```

## Gold Standard Example

```asm
; Complete cartridge abstraction example
SECTION "Code", ROM0[$0150]

; Switch ROM bank (MBC1)
; Input: A = bank number (1-127 for MBC1)
switch_rom_bank:
    ; Per Pan Docs: MBC1 ROM bank switching
    ; Write to $2000-$3FFF to set ROM bank (lower 5 bits)
    ld [$2000], a
    ret

; Switch ROM bank (MBC5, supports more banks)
switch_rom_bank_mbc5:
    ; Per Pan Docs: MBC5 ROM bank switching
    ; Lower 8 bits: $2000-$2FFF
    ; Bit 8: $3000-$3FFF
    ld [$2000], a   ; Lower 8 bits
    ; If bank > 255, set bit 8
    ; (Implementation depends on MBC5 specifics)
    ret

; Enable RAM (MBC1)
enable_ram:
    ; Per Pan Docs: Write $0A to $0000-$1FFF to enable RAM
    ld a, $0A
    ld [$0000], a
    ret

; Disable RAM (MBC1)
disable_ram:
    ; Per Pan Docs: Write $00 to $0000-$1FFF to disable RAM
    xor a
    ld [$0000], a
    ret

; Switch RAM bank (MBC1, if multiple banks)
switch_ram_bank:
    ; Per Pan Docs: Write to $4000-$5FFF to set RAM bank
    ld [$4000], a
    ret

; Read from cartridge RAM
read_cart_ram:
    ; Input: HL = address in RAM area ($A000-$BFFF)
    ; Per Pan Docs: RAM must be enabled first
    call enable_ram
    ld a, [hl]
    call disable_ram
    ret

; Write to cartridge RAM
write_cart_ram:
    ; Input: HL = address in RAM area, A = data
    ; Per Pan Docs: RAM must be enabled first
    push af
    call enable_ram
    pop af
    ld [hl], a
    call disable_ram
    ret
```

## Validation Rules

### Cartridge Access Requirements

1. **MBC Type: Must match cartridge MBC type
2. **Bank Switching: Must use correct MBC registers
3. **RAM Enable: Must enable RAM before access
4. **Bank Numbers: Must use valid bank numbers for MBC type
5. **Header Validation: Must read cartridge header to determine MBC type

### Failure Modes

* **Wrong MBC Type: Bank switching doesn't work
* **Invalid Bank Number: Undefined behavior
* **RAM Not Enabled: RAM writes ignored
* **Header Mismatch: Game doesn't work on hardware

## Cross-References

- Related Fundamentals: 1.3 (Memory Fundamentals), 1.4 (Boot Process)
- Related Advanced Fundamentals: 2.3 (Memory Access Restrictions)
