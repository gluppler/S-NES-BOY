# 1.5 Game Boy Execution Flow

## System Applicability

**This document applies to:**
- ✅ **Game Boy (DMG): Primary focus
- ✅ **Game Boy Color (CGB): Fully compatible

## Physical Hardware Overview

Game Boy execution flow consists of:

* **Reset: Hardware initialization and boot ROM execution
* **Cartridge Entry: Transfer to cartridge code at $0100
* **Initialization: System setup and memory clearing
* **Main Loop: Game logic execution
* **Interrupt Handlers: Hardware event processing
* **VBlank: Frame synchronization boundary

The CPU executes instructions continuously, interrupted by hardware events (VBlank, LCD STAT, Timer, etc.).

## Game Boy Terminology Definitions

* **Reset: Hardware power-on or reset button press
* **Boot ROM: Hardware ROM that executes before cartridge
* **Cartridge Entry: First instruction in cartridge ROM ($0100)
* **Main Loop: Primary game logic execution
* **Interrupt: Hardware event that pauses main execution
* **Interrupt Handler: Code that processes interrupt events
* **VBlank: Vertical blanking period (frame boundary)
* **Frame: One complete screen refresh (154 scanlines)

## Core Rules and Invariants

### Execution Sequence

1. **Power On / Reset:**
   - Hardware initializes
   - Boot ROM executes ($0000-$00FF)
   - Boot ROM validates cartridge
   - Boot ROM transfers to cartridge ($0100)

2. **Cartridge Entry ($0100):**
   - Disable interrupts
   - Initialize stack
   - Clear memory
   - Initialize hardware
   - Enable interrupts
   - Enter main loop

3. **Main Loop:**
   - Game logic execution
   - Input processing
   - State updates
   - Rendering preparation

4. **Interrupt Handlers:**
   - VBlank: Frame synchronization, OAM updates
   - LCD STAT: Mode-specific processing
   - Timer: Time-based events
   - Serial: Communication
   - Joypad: Input handling (CGB only)

5. **Frame Boundary (VBlank):**
   - Safe VRAM/OAM access window
   - Frame counter increment
   - Rendering updates

### Interrupt Priority

* **VBlank: Highest priority (frame synchronization)
* **LCD STAT: Mode change notifications
* **Timer: Periodic events
* **Serial: Communication events
* **Joypad: Input events (CGB only)

## Minimal Correct Usage Example

```asm
SECTION "Start", ROM0[$0150]
Start:
    di
    ld sp, $FFFE
    call init
    ei
    jp main_loop

main_loop:
    halt            ; Wait for interrupt
    jp main_loop

SECTION "VBlank", ROM0[$0040]
    jp vblank_handler

vblank_handler:
    ; VBlank processing
    reti
```

## Gold Standard Example

```asm
; Complete Game Boy execution flow example
SECTION "Reset", ROM0[$0000]
    nop
    jp Start

SECTION "Header", ROM0[$0100]
    nop
    jp Start
    ; ... header data ...

SECTION "VBlank", ROM0[$0040]
    jp vblank_handler

SECTION "LCD STAT", ROM0[$0048]
    jp lcd_stat_handler

SECTION "Timer", ROM0[$0050]
    jp timer_handler

SECTION "Serial", ROM0[$0058]
    jp serial_handler

SECTION "Joypad", ROM0[$0060]
    jp joypad_handler

SECTION "Start", ROM0[$0150]
Start:
    ; Per Pan Docs: Cartridge entry point
    di              ; Disable interrupts
    
    ; Initialize stack
    ld sp, $FFFE
    
    ; Wait for VBlank
    call wait_vblank
    
    ; Disable LCD
    xor a
    ld [rLCDC], a
    
    ; Clear memory
    call clear_wram
    call clear_vram
    call clear_oam
    
    ; Initialize game state
    call init_game
    
    ; Enable LCD
    ld a, %10010001
    ld [rLCDC], a
    
    ; Enable interrupts
    ld a, %00000001  ; VBlank only
    ld [rIE], a
    ei
    
    ; Enter main loop
    jp main_loop

main_loop:
    ; Per Pan Docs: Main loop should use halt for power efficiency
    halt            ; Wait for interrupt (saves power)
    
    ; Game logic (executes after interrupt)
    call process_input
    call update_game_state
    call prepare_rendering
    
    jp main_loop

; Interrupt handlers
vblank_handler:
    push af
    push bc
    push de
    push hl
    
    ; VBlank processing
    ; Per Pan Docs: Safe to access VRAM/OAM during VBlank
    call update_oam
    call update_scroll
    call frame_counter_inc
    
    pop hl
    pop de
    pop bc
    pop af
    reti            ; Return and enable interrupts

lcd_stat_handler:
    push af
    
    ; LCD STAT processing
    ; Per Pan Docs: Can detect mode changes
    ld a, [rSTAT]
    and %00000011   ; Mode bits
    cp 1            ; VBlank?
    jr z, .vblank_detected
    
    pop af
    reti

.vblank_detected:
    ; Mode 1 (VBlank) detected
    pop af
    reti

timer_handler:
    push af
    
    ; Timer processing
    call update_timer
    
    pop af
    reti

serial_handler:
    push af
    
    ; Serial processing
    call handle_serial
    
    pop af
    reti

joypad_handler:
    push af
    
    ; Joypad processing (CGB only)
    call handle_joypad
    
    pop af
    reti
```

## Validation Rules

### Execution Flow Requirements

1. **Interrupt Disable: Must disable interrupts at start
2. **Stack Initialization: Stack pointer must be set before use
3. **Interrupt Handlers: Must preserve all registers
4. **Interrupt Return: Must use reti (not ret)
5. **Main Loop: Should use halt for power efficiency
6. **Frame Synchronization: Must synchronize with VBlank

### Failure Modes

* **Missing Interrupt Disable: Interrupts fire during initialization
* **Uninitialized Stack: Stack operations corrupt memory
* **Register Corruption: Interrupt handlers modify registers without saving
* **Wrong Return: Using ret instead of reti in interrupt handlers
* **No Frame Sync: Game logic runs at inconsistent rates

## Cross-References

- Related Fundamentals: 1.1 (Game Boy System Overview), 1.2 (LR35902 CPU)
- Related Advanced Fundamentals: 2.4 (Interrupt System)
- Related Core Concepts: 3.1 (The Game Loop)
