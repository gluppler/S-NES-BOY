# 2.5 Audio Fundamentals

## System Applicability

**This document applies to:**
- ✅ **NES: Primary focus (Ricoh 2A03 APU)
- ✅ **: Fully compatible (same Ricoh 2A03 APU, plus expansion audio support)

**-Specific Notes:
-  supports **expansion audio** via cartridge (additional sound channels)
- Expansion audio includes extra square waves, sawtooth, and other waveforms
- Expansion audio is not available on NES (hardware limitation)
- Popular expansion audio chips: VRC6, VRC7, FDS audio, etc.


## Hardware Behavior

The **APU (Audio Processing Unit)** is integrated into the Ricoh 2A03 CPU chip. It provides 5 sound channels:

1. **Pulse 1** ($4000–$4003): Square wave, variable duty cycle
2. **Pulse 2** ($4004–$4007): Square wave, variable duty cycle
3. **Triangle** ($4008–$400B): Triangle wave, no volume control
4. **Noise** ($400C–$400F): White noise generator
5. **DMC** ($4010–$4013): Delta Modulation Channel, 7-bit samples

The APU also has a **frame counter** ($4017) that generates timing signals for:
* Length counter updates
* Envelope updates
* Linear counter updates (triangle channel)

## Why This Behavior Exists

The APU was designed for cost-effective sound generation. Each channel uses simple waveform generators (square, triangle, noise) that require minimal silicon. The frame counter provides automatic timing for sound effects (envelopes, length counters) without CPU intervention.

The DMC channel allows playback of pre-recorded samples (drums, speech) but requires significant CPU bandwidth for DMA transfers.

## Exact Rules and Constraints

### APU Channels Overview

| Channel | Registers | Waveform | Volume Control | Notes |
|---------|-----------|----------|----------------|-------|
| Pulse 1 | $4000–$4003 | Square (12.5%, 25%, 50%, 75%) | Yes (envelope) | Can sweep frequency |
| Pulse 2 | $4004–$4007 | Square (12.5%, 25%, 50%, 75%) | Yes (envelope) | Can sweep frequency |
| Triangle | $4008–$400B | Triangle | No (linear counter only) | No volume control |
| Noise | $400C–$400F | White noise | Yes (envelope) | 15-bit or 7-bit LFSR |
| DMC | $4010–$4013 | 7-bit samples | Yes (sample data) | Requires DMA |

### Frame Counter

**Register $4017** (write):
* Bit 7: Frame counter mode (0 = 4-step, 1 = 5-step)
* Bit 6: Interrupt inhibit (1 = disable frame counter IRQ)

**Frame Counter Modes:
* **4-step mode: 4-frame sequence (240 Hz timing)
  - Frame 1: Length counters, envelopes
  - Frame 2: Length counters, envelopes, sweep
  - Frame 3: Length counters, envelopes
  - Frame 4: Length counters, envelopes, sweep, IRQ (if enabled)
* **5-step mode: 5-frame sequence (192 Hz timing)
  - Frame 1: Length counters, envelopes
  - Frame 2: Length counters, envelopes, sweep
  - Frame 3: Length counters, envelopes
  - Frame 4: Length counters, envelopes, sweep
  - Frame 5: (no updates)

### Why Audio Timing Is Fragile

* **Frame counter synchronization: Must write to $4017 at specific times
* **Length counter updates: Automatic, frame-counter driven
* **Envelope updates: Automatic, frame-counter driven
* **DMC DMA: Steals CPU cycles (4 cycles per sample byte)
* **Register write timing: Some registers must be written at specific frame phases

## Frame Counter Timing Tables

### 4-Step Mode (240 Hz)

| Frame | Length Counter | Envelope | Sweep | IRQ | Notes |
|-------|----------------|----------|-------|-----|-------|
| 1 | ✅ Update | ✅ Update | — | — | Quarter frame |
| 2 | ✅ Update | ✅ Update | ✅ Update | — | Half frame |
| 3 | ✅ Update | ✅ Update | — | — | Quarter frame |
| 4 | ✅ Update | ✅ Update | ✅ Update | ✅ Fire | Half frame + IRQ |

**Timing**: Updates occur at 240 Hz (every 4 frames = 66.67 ms intervals)

### 5-Step Mode (192 Hz)

| Frame | Length Counter | Envelope | Sweep | IRQ | Notes |
|-------|----------------|----------|-------|-----|-------|
| 1 | ✅ Update | ✅ Update | — | — | Quarter frame |
| 2 | ✅ Update | ✅ Update | ✅ Update | — | Half frame |
| 3 | ✅ Update | ✅ Update | — | — | Quarter frame |
| 4 | ✅ Update | ✅ Update | ✅ Update | — | Half frame |
| 5 | — | — | — | — | No updates |

**Timing**: Updates occur at 192 Hz (every 5 frames = 83.33 ms intervals)

### Frame Counter Initialization

**Critical**: Frame counter must be initialized at startup and reset every frame.

```asm
; Initialize frame counter (in reset handler)
init_apu:
    ; Disable all channels first
    LDA #$00
    STA $4015
    
    ; Initialize frame counter (5-step mode, no IRQ)
    LDA #%11000000  ; Bit 7=1 (5-step), Bit 6=1 (IRQ inhibit)
    STA $4017
    
    ; Enable channels
    LDA #%00001111  ; Enable pulse 1, 2, triangle, noise
    STA $4015
    RTS

; Reset frame counter every frame (in NMI)
nmi:
    ; ... other NMI code ...
    
    ; Reset frame counter (must be done every frame)
    LDA #%11000000  ; 5-step mode, IRQ inhibit
    STA $4017       ; Resets frame counter to frame 1
    
    ; ... rest of NMI ...
```

**Why reset every frame**: Frame counter continues counting even when channels are disabled. Resetting ensures consistent timing.

## Timing Considerations

### Frame Counter Timing

* **4-step mode: 240 Hz (every 4 frames)
* **5-step mode: 192 Hz (every 5 frames)
* **Write timing: Must write to $4017 at start of frame (in NMI)
* **Synchronization: Writing $4017 resets frame counter

### Frame Counter Write Timing

**Critical timing**: Write to $4017 must occur at a consistent point each frame.

**Best practice**: Write in NMI handler, immediately after reading $2002.

```asm
nmi:
    LDA $2002       ; Clear VBlank flag
    
    ; Reset frame counter (timing-critical)
    LDA #%11000000  ; 5-step mode, IRQ inhibit
    STA $4017       ; Must write at consistent time
    
    ; ... rest of NMI ...
```

**Why timing matters**: Frame counter updates occur at specific frame phases. Writing at inconsistent times causes audio desynchronization.

### DMC DMA Timing

* **Sample rate: 4.18 kHz to 33.5 kHz (controlled by $4010)
* **DMA cycles: 4 CPU cycles per sample byte
* **CPU impact: DMC DMA can steal up to 28% of CPU time (at max rate)
* **Timing: DMA occurs during CPU instruction execution

### DMC Sample Rate Table

| $4010 bits 3-0 | Sample Rate (Hz) | Period (CPU cycles) | CPU Impact |
|----------------|------------------|---------------------|------------|
| $0 | 4,180 | ~428 | 1.7% |
| $1 | 4,726 | ~379 | 1.9% |
| $2 | 5,263 | ~340 | 2.1% |
| $3 | 5,597 | ~320 | 2.3% |
| $4 | 6,260 | ~286 | 2.6% |
| $5 | 7,052 | ~254 | 3.0% |
| $6 | 7,891 | ~227 | 3.4% |
| $7 | 8,369 | ~214 | 3.6% |
| $8 | 9,395 | ~191 | 4.0% |
| $9 | 10,497 | ~171 | 4.5% |
| $A | 11,192 | ~160 | 4.8% |
| $B | 12,558 | ~143 | 5.4% |
| $C | 14,006 | ~128 | 6.0% |
| $D | 15,746 | ~114 | 6.7% |
| $E | 16,744 | ~107 | 7.1% |
| $F | 18,818 | ~95 | 7.9% |

**CPU Impact**: Percentage of CPU cycles stolen by DMC DMA at maximum sample rate.

**Best practice**: Keep DMC sample rate <10 kHz to limit CPU impact.

### DMC DMA Behavior

**DMA occurs during instruction execution:**
- DMC DMA steals cycles from **current instruction**
- Instruction takes longer to complete (adds 4 cycles per byte)
- DMA is **non-blocking** (CPU continues, but slower)

**Example:**
```asm
; Instruction that would normally take 4 cycles
    LDA $0300        ; 4 cycles normally
    
; If DMC DMA occurs during this instruction:
    LDA $0300        ; 4 cycles + 4 DMA cycles = 8 cycles total
```

**Impact on timing**: DMC DMA can cause timing drift in cycle-critical code.

### DMC IRQ Behavior

**DMC IRQ** ($4010 bit 7):
- When set: DMC generates IRQ when sample playback completes
- IRQ fires at end of sample (not during playback)
- Must handle IRQ or disable it (set bit 7 = 0)

**Best practice**: Disable DMC IRQ unless you need sample completion notification.

```asm
; Disable DMC IRQ
    LDA $4010
    AND #%01111111  ; Clear bit 7 (IRQ disable)
    STA $4010
```

## Channel-Specific Quirks and Constraints

### Pulse Channels (1 & 2)

**Duty Cycle:**
- 12.5% ($00): Short pulse
- 25% ($40): Medium pulse
- 50% ($80): Square wave (most common)
- 75% ($C0): Wide pulse

**Sweep Unit:**
- Can sweep frequency up or down
- Sweep rate: 0-7 (0 = disabled)
- Sweep shift: 0-7 (frequency change amount)
- **Sweep can mute channel** if frequency goes too high/low

**Length Counter:**
- Counts down from lookup table value
- Channel stops when counter reaches 0
- Can be disabled (infinite length) via bit 5 of $4003/$4007

### Triangle Channel

**Special behavior:**
- **No volume control** (always full volume)
- Uses linear counter (not length counter)
- Linear counter controls note duration
- **Silent when linear counter = 0**

**Linear Counter:**
- Controlled by $4008 bit 7 (halt flag) and bits 0-6 (reload value)
- Counts down during frame counter updates
- When counter = 0, triangle channel is silent

**Best practice**: Set linear counter reload value to prevent premature silence.

### Noise Channel

**Noise generator:**
- 15-bit LFSR (Linear Feedback Shift Register)
- Mode bit ($400E bit 7): 0 = 15-bit, 1 = 7-bit
- 15-bit mode: Lower frequency, longer period
- 7-bit mode: Higher frequency, shorter period

**Period values:**
- Range: 0-15 (encoded in $400E bits 0-3)
- Lower period = higher frequency = more "hissy" sound
- Period 0 = highest frequency (white noise)

### DMC Channel

**Sample playback:**
- Plays 7-bit delta-encoded samples
- Sample data stored in CPU memory ($C000-$FFFF typically)
- DMA transfers sample bytes to DMC
- **DMA steals CPU cycles** (4 cycles per byte)

**Sample format:**
- 7-bit delta encoding (each byte is relative change)
- Sample rate controlled by $4010
- Loop flag ($4010 bit 6): Repeats sample when done

**Best practice**: Keep samples short and sample rate low to minimize CPU impact.

## Common Mistakes and Incorrect Assumptions

* **Not initializing frame counter: $4017 must be written to start frame counter
* **Writing registers at wrong time: Some writes must occur during specific frame phases
* **Ignoring DMC DMA overhead: High DMC rates can cause frame drops
* **Not handling frame counter IRQ: 4-step mode generates IRQ (must be handled or disabled)
* **Assuming all channels work the same: Triangle has no volume control, DMC uses DMA
* **Not accounting for envelope timing: Envelopes update automatically, not immediately
* **Not resetting frame counter every frame: Frame counter continues counting, must reset
* **Writing $4017 at wrong time: Frame counter timing is critical
* **DMC sample rate too high: Steals too many CPU cycles, causes frame drops
* **Triangle linear counter not set: Triangle channel may be silent

## APU Anti-Patterns

### ❌ Anti-Pattern: Not Initializing Frame Counter

```asm
; BAD: Frame counter not initialized
init_audio:
    LDA #%00001111
    STA $4015       ; Enable channels
    ; Missing: Frame counter initialization
    RTS
```

```asm
; GOOD: Initialize frame counter
init_audio:
    LDA #$00
    STA $4015       ; Disable all channels first
    
    LDA #%11000000  ; 5-step mode, IRQ inhibit
    STA $4017       ; Initialize frame counter
    
    LDA #%00001111
    STA $4015       ; Enable channels
    RTS
```

### ❌ Anti-Pattern: Not Resetting Frame Counter Every Frame

```asm
; BAD: Frame counter not reset (causes desync)
nmi:
    LDA $2002
    ; Missing: Frame counter reset
    ; Frame counter continues counting, timing drifts
    RTI
```

```asm
; GOOD: Reset frame counter every frame
nmi:
    LDA $2002
    
    ; Reset frame counter (timing-critical)
    LDA #%11000000  ; 5-step mode, IRQ inhibit
    STA $4017       ; Resets to frame 1
    
    ; ... rest of NMI ...
    RTI
```

### ❌ Anti-Pattern: DMC Sample Rate Too High

```asm
; BAD: DMC at maximum rate (steals 7.9% of CPU)
    LDA #%11111111  ; Max rate, loop, IRQ
    STA $4010       ; Too high, causes frame drops
```

```asm
; GOOD: Moderate DMC rate
    LDA #%01001000  ; Rate $8 (9.4 kHz), loop enabled, no IRQ
    STA $4010       ; Reasonable CPU impact (4.0%)
```

### ❌ Anti-Pattern: Triangle Linear Counter Not Set

```asm
; BAD: Triangle may be silent
    LDA #$00
    STA $4008       ; Linear counter = 0, triangle silent
```

```asm
; GOOD: Set linear counter reload value
    LDA #$7F        ; Halt flag = 0, reload = 127
    STA $4008       ; Triangle will play
```

## Debugging APU Issues

### Problem: No sound output

**Check:**
1. Frame counter initialized ($4017 written)
2. Channels enabled ($4015 bits set)
3. Triangle linear counter set ($4008)
4. Pulse length counter not expired
5. Volume envelope not at 0

### Problem: Sound desynchronizes

**Check:**
1. Frame counter reset every frame (write $4017 in NMI)
2. Frame counter write timing (consistent point in frame)
3. Frame counter mode (4-step vs 5-step)
4. Channel register write timing

### Problem: Frame drops with DMC

**Check:**
1. DMC sample rate (keep <10 kHz)
2. DMC sample size (shorter samples = less CPU impact)
3. DMC loop flag (looping samples = continuous CPU impact)
4. CPU cycle budget (account for DMC DMA cycles)

### Problem: Triangle channel silent

**Check:**
1. Linear counter reload value ($4008 bits 0-6)
2. Linear counter halt flag ($4008 bit 7)
3. Length counter (if enabled)
4. Channel enabled ($4015 bit 2)

## Observable Symptoms When Rules Are Violated

* **Audio glitches: Timing errors cause clicks, pops, or distortion
* **Missing sounds: Length counters expire prematurely
* **Volume issues: Envelopes not updating correctly
* **Frame drops: DMC DMA steals too many cycles
* **Desynchronized music: Frame counter not initialized correctly
* **IRQ conflicts: Frame counter IRQ conflicts with NMI

## Minimal Example

```asm
; Initialize APU
init_audio:
    ; Disable all channels
    LDA #$00
    STA $4015       ; Disable all channels
    
    ; Initialize frame counter (5-step mode, no IRQ)
    LDA #%11000000  ; 5-step mode, IRQ inhibit
    STA $4017
    
    ; Enable channels
    LDA #%00001111  ; Enable pulse 1, pulse 2, triangle, noise
    STA $4015
    
    RTS

; Play a note on pulse 1
play_note:
    ; Set duty cycle and volume envelope
    LDA #%00111111  ; Duty 50%, volume 15, constant volume
    STA $4000
    
    ; Set period (frequency)
    LDA #<440       ; Low byte of period (440 Hz example)
    STA $4002
    LDA #>440       ; High byte of period
    STA $4003
    
    ; Set length counter (prevents note from stopping immediately)
    LDA #%10000000  ; Length counter disable (infinite)
    STA $4003       ; Write again to set length counter
    
    RTS

; Update audio (call once per frame)
update_audio:
    ; Frame counter updates happen automatically
    ; Just ensure $4017 was written in NMI
    
    ; Update music/sound effects here
    ; (FamiTone2 or custom music engine)
    
    RTS
```

## Cross-References

- Related Fundamentals: 1.1 (NES System Overview)
- Related Advanced Fundamentals: 2.1 (CPU Timing & Cycles)
- Related Core Concepts: None (audio is mostly independent)
- Related Cheatsheets: 4.5 (Audio Cheatsheets)
- Hardware Schematics: [`schematics/nes/`](../../../../schematics/nes/README.md) - APU circuit diagrams (integrated in 2A03 CPU)
