# 2.5 Audio Fundamentals

## System Applicability

**This document applies to:**
- ✅ **NES: Primary focus (Ricoh 2A03 APU)
- ✅ **: Fully compatible (same Ricoh 2A03 APU, plus expansion audio support)

**-Specific Notes:
-  supports **expansion audio** via cartridge (additional sound channels)
- Expansion audio includes extra square waves, sawtooth, and other waveforms
- Expansion audio is not available on NES (hardware limitation)
- Popular expansion audio chips: VRC6, VRC7, FDS audio, etc.


## Hardware Behavior

The **APU (Audio Processing Unit)** is integrated into the Ricoh 2A03 CPU chip. It provides 5 sound channels:

1. **Pulse 1** ($4000–$4003): Square wave, variable duty cycle
2. **Pulse 2** ($4004–$4007): Square wave, variable duty cycle
3. **Triangle** ($4008–$400B): Triangle wave, no volume control
4. **Noise** ($400C–$400F): White noise generator
5. **DMC** ($4010–$4013): Delta Modulation Channel, 7-bit samples

The APU also has a **frame counter** ($4017) that generates timing signals for:
* Length counter updates
* Envelope updates
* Linear counter updates (triangle channel)

## Why This Behavior Exists

The APU was designed for cost-effective sound generation. Each channel uses simple waveform generators (square, triangle, noise) that require minimal silicon. The frame counter provides automatic timing for sound effects (envelopes, length counters) without CPU intervention.

The DMC channel allows playback of pre-recorded samples (drums, speech) but requires significant CPU bandwidth for DMA transfers.

## Exact Rules and Constraints

### APU Channels Overview

| Channel | Registers | Waveform | Volume Control | Notes |
|---------|-----------|----------|----------------|-------|
| Pulse 1 | $4000–$4003 | Square (12.5%, 25%, 50%, 75%) | Yes (envelope) | Can sweep frequency |
| Pulse 2 | $4004–$4007 | Square (12.5%, 25%, 50%, 75%) | Yes (envelope) | Can sweep frequency |
| Triangle | $4008–$400B | Triangle | No (linear counter only) | No volume control |
| Noise | $400C–$400F | White noise | Yes (envelope) | 15-bit or 7-bit LFSR |
| DMC | $4010–$4013 | 7-bit samples | Yes (sample data) | Requires DMA |

### Frame Counter

**Register $4017** (write):
* Bit 7: Frame counter mode (0 = 4-step, 1 = 5-step)
* Bit 6: Interrupt inhibit (1 = disable frame counter IRQ)

**Frame Counter Modes:
* **4-step mode: 4-frame sequence (240 Hz timing)
  - Frame 1: Length counters, envelopes
  - Frame 2: Length counters, envelopes, sweep
  - Frame 3: Length counters, envelopes
  - Frame 4: Length counters, envelopes, sweep, IRQ (if enabled)
* **5-step mode: 5-frame sequence (192 Hz timing)
  - Frame 1: Length counters, envelopes
  - Frame 2: Length counters, envelopes, sweep
  - Frame 3: Length counters, envelopes
  - Frame 4: Length counters, envelopes, sweep
  - Frame 5: (no updates)

### Why Audio Timing Is Fragile

* **Frame counter synchronization: Must write to $4017 at specific times
* **Length counter updates: Automatic, frame-counter driven
* **Envelope updates: Automatic, frame-counter driven
* **DMC DMA: Steals CPU cycles (4 cycles per sample byte)
* **Register write timing: Some registers must be written at specific frame phases

## Timing Considerations

### Frame Counter Timing

* **4-step mode: 240 Hz (every 4 frames)
* **5-step mode: 192 Hz (every 5 frames)
* **Write timing: Must write to $4017 at start of frame (in NMI)
* **Synchronization: Writing $4017 resets frame counter

### DMC DMA Timing

* **Sample rate: 4.18 kHz to 33.5 kHz (controlled by $4010)
* **DMA cycles: 4 CPU cycles per sample byte
* **CPU impact: DMC DMA can steal up to 28% of CPU time (at max rate)
* **Timing: DMA occurs during CPU instruction execution

## Common Mistakes and Incorrect Assumptions

* **Not initializing frame counter: $4017 must be written to start frame counter
* **Writing registers at wrong time: Some writes must occur during specific frame phases
* **Ignoring DMC DMA overhead: High DMC rates can cause frame drops
* **Not handling frame counter IRQ: 4-step mode generates IRQ (must be handled or disabled)
* **Assuming all channels work the same: Triangle has no volume control, DMC uses DMA
* **Not accounting for envelope timing: Envelopes update automatically, not immediately

## Observable Symptoms When Rules Are Violated

* **Audio glitches: Timing errors cause clicks, pops, or distortion
* **Missing sounds: Length counters expire prematurely
* **Volume issues: Envelopes not updating correctly
* **Frame drops: DMC DMA steals too many cycles
* **Desynchronized music: Frame counter not initialized correctly
* **IRQ conflicts: Frame counter IRQ conflicts with NMI

## Minimal Example

```asm
; Initialize APU
init_audio:
    ; Disable all channels
    LDA #$00
    STA $4015       ; Disable all channels
    
    ; Initialize frame counter (5-step mode, no IRQ)
    LDA #%11000000  ; 5-step mode, IRQ inhibit
    STA $4017
    
    ; Enable channels
    LDA #%00001111  ; Enable pulse 1, pulse 2, triangle, noise
    STA $4015
    
    RTS

; Play a note on pulse 1
play_note:
    ; Set duty cycle and volume envelope
    LDA #%00111111  ; Duty 50%, volume 15, constant volume
    STA $4000
    
    ; Set period (frequency)
    LDA #<440       ; Low byte of period (440 Hz example)
    STA $4002
    LDA #>440       ; High byte of period
    STA $4003
    
    ; Set length counter (prevents note from stopping immediately)
    LDA #%10000000  ; Length counter disable (infinite)
    STA $4003       ; Write again to set length counter
    
    RTS

; Update audio (call once per frame)
update_audio:
    ; Frame counter updates happen automatically
    ; Just ensure $4017 was written in NMI
    
    ; Update music/sound effects here
    ; (FamiTone2 or custom music engine)
    
    RTS
```

## Cross-References

- Related Fundamentals: 1.1 (NES System Overview)
- Related Advanced Fundamentals: 2.1 (CPU Timing & Cycles)
- Related Core Concepts: None (audio is mostly independent)
- Related Cheatsheets: 4.5 (Audio Cheatsheets)
