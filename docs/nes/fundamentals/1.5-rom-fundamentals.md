# 1.5 ROM Fundamentals

## System Applicability

**This document applies to:**
- ✅ **NES**: Primary focus (cartridge-based ROM)

## Physical Hardware Overview

NES cartridges contain:

* **PRG ROM: Program ROM, contains CPU-executable code and data
* **CHR ROM: Character ROM, contains PPU pattern table data (tiles)
* **Optional CHR RAM: Writable CHR memory (rare, requires battery)
* **Optional PRG RAM: Battery-backed save RAM ($6000–$7FFF)
* **Mapper hardware: Logic that remaps ROM banks to CPU/PPU address space
* **iNES header: 16-byte metadata at start of ROM file

The simplest cartridge uses **Mapper 0 (NROM)**, which provides fixed or mirrored PRG/CHR banks with no bank switching.

## NES Terminology Definitions

* **iNES Header: 16-byte header format defining ROM structure
* **PRG ROM: Program ROM, mapped to CPU address space ($8000–$FFFF)
* **CHR ROM: Character ROM, mapped to PPU address space ($0000–$1FFF)
* **Mapper: Cartridge hardware that performs bank switching
* **Mapper 0 (NROM): Simplest mapper, no bank switching
* **Bank: Contiguous block of ROM (typically 8 KB PRG, 8 KB CHR)
* **Mirroring: Duplicating ROM banks to fill address space

## Core Rules and Invariants

### iNES Header

The iNES header (16 bytes) structure:

| Offset | Size | Description |
|--------|------|-------------|
| 0–3 | 4 | Magic: "NES" + $1A |
| 4 | 1 | PRG ROM size (16 KB units) |
| 5 | 1 | CHR ROM size (8 KB units, 0 = CHR RAM) |
| 6 | 1 | Flags 6: Mapper low, mirroring, battery, trainer |
| 7 | 1 | Flags 7: Mapper high, VS/Playchoice, NES 2.0 |
| 8 | 1 | PRG RAM size (8 KB units, rarely used) |
| 9 | 1 | TV system (0=NTSC, 1=PAL) |
| 10 | 6 | Unused (should be 0) |

Key flags in byte 6:
* Bit 0: Mirroring (0=horizontal, 1=vertical)
* Bit 1: Battery-backed PRG RAM
* Bit 2: Trainer present (512 bytes before PRG ROM)
* Bit 3: Ignore mirroring (use 4-screen VRAM)
* Bits 4–7: Mapper number (low 4 bits)

### PRG ROM vs CHR ROM

* **PRG ROM: Contains CPU code/data, mapped to $8000–$FFFF
  - Typical sizes: 16 KB, 32 KB, 128 KB, 256 KB, 512 KB
  - If 16 KB: mirrored to both $8000–$BFFF and $C000–$FFFF
  - If 32 KB: $8000–$FFFF (no mirroring)
* **CHR ROM: Contains PPU pattern data, mapped to $0000–$1FFF
  - Typical sizes: 8 KB, 16 KB, 32 KB, 128 KB
  - Always 8 KB visible at once (pattern tables 0 and 1)

### Mapper 0 (NROM) Mental Model

Mapper 0 is the simplest mapper:

* **16 KB PRG: 
  - Bank at $8000–$BFFF
  - Same bank mirrored at $C000–$FFFF
* **32 KB PRG:
  - Bank at $8000–$FFFF (no mirroring)
* **8 KB CHR:
  - Fixed at $0000–$1FFF
* **16 KB CHR:
  - First 8 KB at $0000–$0FFF
  - Second 8 KB at $1000–$1FFF
* **No bank switching: ROM is fixed in address space

### ROM File Layout

```
[0x0000] iNES Header (16 bytes)
[0x0010] Trainer (512 bytes, if present)
[0x0210] PRG ROM (16 KB × PRG_SIZE)
[0x4210] CHR ROM (8 KB × CHR_SIZE, if CHR_SIZE > 0)
```

## Minimal Correct Usage Example

```asm
; iNES header for 32 KB PRG, 8 KB CHR, Mapper 0, horizontal mirroring
.segment "HEADER"
    .byte "NES", $1A    ; Magic
    .byte 2             ; 32 KB PRG (2 × 16 KB)
    .byte 1             ; 8 KB CHR (1 × 8 KB)
    .byte %00000000     ; Mapper 0, horizontal mirroring, no battery
    .byte %00000000     ; Mapper 0 (high), NES format
    .byte 0             ; PRG RAM size
    .byte 0             ; NTSC
    .byte 0, 0, 0, 0, 0, 0  ; Unused

; Reset vector points to reset handler
.segment "VECTORS"
    .addr nmi, reset, irq

; PRG ROM code
.segment "CODE"
reset:
    ; ... initialization ...

; CHR ROM data (tiles)
.segment "CHARS"
    .incbin "tiles.chr"
```

## Gold Standard Example

```asm
; Complete iNES header and ROM structure example
.segment "HEADER"
    .byte "NES", $1A    ; iNES magic number
    .byte 2             ; 32 KB PRG ROM (2 * 16 KB)
    .byte 1             ; 8 KB CHR ROM (1 * 8 KB)
    .byte %00000000     ; Mapper 0, horizontal mirroring, no battery
    .byte %00000000     ; Mapper 0 (high), NES format
    .byte 0             ; PRG RAM size (0 = no battery RAM)
    .byte 0             ; TV system (0 = NTSC, 1 = PAL)
    .byte 0, 0, 0, 0, 0, 0  ; Unused bytes (must be 0)

; Interrupt vectors (must be at $FFFA-$FFFF)
.segment "VECTORS"
    .addr nmi, reset, irq

; PRG ROM code (mapped to $8000-$FFFF)
.segment "CODE"
    ; Code starts here
    .org $8000

reset:
    ; Reset handler code
    SEI
    CLD
    ; ... initialization ...
    JMP main_loop

nmi:
    ; NMI handler code
    RTI

irq:
    ; IRQ handler code
    RTI

main_loop:
    ; Main game loop
    JMP main_loop

; Data in PRG ROM
palette_data:
    .byte $0F, $30, $10, $00  ; Background palette 0
    .byte $0F, $30, $10, $00  ; Background palette 1
    .byte $0F, $30, $10, $00  ; Background palette 2
    .byte $0F, $30, $10, $00  ; Background palette 3
    .byte $0F, $16, $27, $18  ; Sprite palette 0
    .byte $0F, $16, $27, $18  ; Sprite palette 1
    .byte $0F, $16, $27, $18  ; Sprite palette 2
    .byte $0F, $16, $27, $18  ; Sprite palette 3

; CHR ROM data (mapped to PPU $0000-$1FFF)
.segment "CHARS"
    .incbin "graphics.chr"    ; 8 KB CHR ROM file
```

## Validation Rules

### iNES Header Rules

1. **Magic Number: First 4 bytes must be "NES" + $1A
2. **PRG ROM Size: Must match actual PRG ROM size (16 KB units)
3. **CHR ROM Size: Must match actual CHR ROM size (8 KB units, 0 = CHR RAM)
4. **Mapper Number: Must correctly identify mapper hardware
5. **Mirroring: Must match cartridge mirroring configuration
6. **Battery Flag: Must be set if cartridge has battery-backed RAM
7. **TV System: Must match target region (NTSC vs PAL)
8. **Unused Bytes: Bytes 8-15 must be 0

### ROM Structure Rules

1. **Header Location: iNES header must be at start of ROM file
2. **Vector Location: Interrupt vectors must be at $FFFA-$FFFF
3. **Code Location: PRG ROM code must be at $8000-$FFFF
4. **CHR Location: CHR ROM data must be at PPU $0000-$1FFF
5. **Size Matching: Actual ROM size must match header values
6. **Mapper Compatibility: Code must match mapper capabilities

### Failure Modes

* **Invalid Magic Number: Emulator rejects ROM file
* **Size Mismatch: ROM size doesn't match header, causes loading errors
* **Wrong Mapper: Code assumes wrong mapper capabilities, crashes
* **Missing Vectors: Interrupts jump to wrong address, system crashes
* **CHR Size Error: PPU pattern tables incorrect, graphics corrupted
* **Mirroring Mismatch: Background rendering incorrect, screen misaligned

## Mapper Responsibilities and Bank Switching

**Hardware Schematics**: See [`schematics/nes/`](../../../../schematics/nes/README.md) for detailed circuit diagrams of various mapper implementations (NROM, CNROM, UNROM, SNROM/MMC1, TLROM/MMC3, etc.).

### What Mappers Do

**Mappers** are cartridge hardware that remap ROM banks to CPU/PPU address space:

1. **PRG Bank Switching**: Remap PRG ROM banks to $8000–$FFFF
2. **CHR Bank Switching**: Remap CHR ROM/RAM banks to PPU $0000–$1FFF
3. **Mirroring Control**: Control name table mirroring (horizontal/vertical/4-screen)
4. **PRG RAM Banking**: Remap PRG RAM banks to $6000–$7FFF
5. **Additional Features**: IRQ generation, audio expansion, etc.

### Mapper 0 (NROM) - No Bank Switching

**Mapper 0** is the simplest mapper with **no bank switching**:

| ROM Size | CPU Mapping | Notes |
|----------|-------------|-------|
| 16 KB PRG | $8000–$BFFF (mirrored to $C000–$FFFF) | Same bank appears twice |
| 32 KB PRG | $8000–$FFFF | No mirroring |
| 8 KB CHR | PPU $0000–$1FFF | Fixed pattern tables |
| 16 KB CHR | PPU $0000–$1FFF | First 8 KB visible, second 8 KB unused |

**Mapper 0 Limitations:**
- Maximum 32 KB PRG ROM
- Maximum 16 KB CHR ROM (only 8 KB visible)
- No bank switching
- No PRG RAM support

### CHR ROM vs CHR RAM

**CHR ROM (Character ROM):**
- **Read-only** pattern table data
- Stored in cartridge ROM
- Cannot be modified by CPU
- Typical sizes: 8 KB, 16 KB, 32 KB, 128 KB
- **Bank switching** allows switching between CHR ROM banks

**CHR RAM (Character RAM):**
- **Writable** pattern table data
- Stored in cartridge RAM (requires battery for persistence)
- Can be modified by CPU during VBlank
- Typical size: 8 KB
- Allows dynamic tile generation

**CHR ROM vs CHR RAM Comparison:**

| Aspect | CHR ROM | CHR RAM |
|--------|---------|---------|
| Writable | ❌ No | ✅ Yes |
| Persistent | ✅ Yes (ROM) | ⚠️ Requires battery |
| Bank switching | ✅ Yes (if mapper supports) | ✅ Yes (if mapper supports) |
| Dynamic tiles | ❌ No | ✅ Yes |
| Cost | Lower | Higher (requires RAM) |

**Switching to CHR RAM:**
- Some mappers support switching between CHR ROM and CHR RAM
- Requires mapper-specific register writes
- CHR RAM must be initialized (cleared or loaded with data)

### Bank Switching Basics

**PRG Bank Switching:**
- Switches 8 KB or 16 KB PRG ROM banks
- Writes to mapper registers control bank selection
- Allows games larger than 32 KB PRG ROM

**CHR Bank Switching:**
- Switches 1 KB, 2 KB, 4 KB, or 8 KB CHR ROM/RAM banks
- Writes to mapper registers control bank selection
- Allows games larger than 8 KB CHR ROM

**Bank Switching Example (Conceptual):**
```asm
; Mapper register write (mapper-specific)
    LDA #bank_number
    STA mapper_register    ; Switch to bank N
    
    ; Now $8000-$FFFF (or PPU $0000-$1FFF) maps to different ROM bank
```

### Common Mappers

| Mapper | PRG Banks | CHR Banks | Features | Notes |
|--------|-----------|-----------|----------|-------|
| 0 (NROM) | Fixed | Fixed | None | Simplest, no bank switching |
| 1 (MMC1) | 16 KB | 8 KB | PRG/CHR banking, mirroring | Serial register interface |
| 2 (UxROM) | 16 KB | Fixed | PRG banking | Simple PRG bank switching |
| 3 (CNROM) | Fixed | 8 KB | CHR banking | Simple CHR bank switching |
| 4 (MMC3) | 8 KB | 1 KB | PRG/CHR banking, IRQ | Complex, popular mapper |

**Note**: Mapper details are beyond this fundamentals document. See mapper-specific documentation for implementation details.

### Mapper Register Access

**Mapper registers** are typically accessed via:
- **$6000–$7FFF**: PRG RAM area (some mappers use for registers)
- **$8000–$FFFF**: PRG ROM area (writes to ROM space trigger mapper)
- **Cartridge expansion area**: $4020–$5FFF (mapper-specific)

**Critical**: Mapper register writes are **write-only**. Reading from mapper register addresses returns ROM data, not register values.

### Bank Switching Side Effects

**Important Considerations:**
1. **Code execution**: Bank switching during code execution can cause crashes
2. **Data access**: Switching banks while accessing data can cause corruption
3. **Interrupts**: Bank switching during interrupts requires careful handling
4. **Timing**: Some mappers have timing constraints on bank switches

**Best Practice**: Switch banks only when safe (e.g., during VBlank, between levels).

## Mapper Programming Pitfalls

### ❌ Common Mistakes

**Mistake 1: Switching banks during code execution**
```asm
; BAD: Switching PRG bank while executing code
    LDA #1
    STA mapper_register    ; Switches bank
    ; Code continues, but may be in wrong bank now!
```

**Mistake 2: Accessing data after bank switch**
```asm
; BAD: Data pointer may point to wrong bank
    LDA #new_bank
    STA mapper_register
    LDA data_table,X       ; data_table may be in old bank!
```

**Mistake 3: Not initializing CHR RAM**
```asm
; BAD: CHR RAM contains garbage
    ; Switch to CHR RAM
    ; Use CHR RAM without clearing (garbage tiles appear)
```

### ✅ Correct Patterns

**Pattern 1: Switch banks at safe points**
```asm
; GOOD: Switch banks during VBlank
nmi:
    ; ... update rendering ...
    
    ; Switch PRG bank for next level
    LDA next_level_bank
    STA mapper_register
    
    ; Bank switch complete, safe to continue
```

**Pattern 2: Keep code in fixed bank**
```asm
; GOOD: Keep core code in fixed bank (e.g., $C000-$FFFF)
    ; Core code always available
    ; Switch only data banks ($8000-$BFFF)
```

**Pattern 3: Initialize CHR RAM**
```asm
; GOOD: Clear CHR RAM before use
init_chr_ram:
    ; Switch to CHR RAM
    LDA #CHR_RAM_BANK
    STA mapper_register
    
    ; Clear CHR RAM during VBlank
    LDA $2002
    LDA #$00
    STA $2006
    STA $2006
    LDX #0
    LDA #0
clear_loop:
    STA $2007
    INX
    BNE clear_loop
```

## Explicit Non-Goals

This section does not cover:
* Detailed mapper implementations (MMC1, MMC3, etc.) - See mapper-specific docs
* Advanced bank switching techniques - See mapper-specific docs
* PRG RAM (save data) handling - See save system documentation
* ROM file format details beyond iNES header - See ROM format documentation
* Mapper register details - See mapper-specific documentation

## Cross-References

- Related Fundamentals: 1.1 (System Overview), 1.3 (Memory), 1.4 (PPU)
- Related Advanced Fundamentals: None (ROM is static)
- Related Core Concepts: None (ROM is data, not a system)
- Related Cheatsheets: None (ROM format is tooling-specific)
