# 1.5 ROM Fundamentals

## System Applicability

**This document applies to:**
- ✅ **NES: Primary focus (cartridge-based ROM)

## Physical Hardware Overview

NES cartridges contain:

* **PRG ROM: Program ROM, contains CPU-executable code and data
* **CHR ROM: Character ROM, contains PPU pattern table data (tiles)
* **Optional CHR RAM: Writable CHR memory (rare, requires battery)
* **Optional PRG RAM: Battery-backed save RAM ($6000–$7FFF)
* **Mapper hardware: Logic that remaps ROM banks to CPU/PPU address space
* **iNES header: 16-byte metadata at start of ROM file

The simplest cartridge uses **Mapper 0 (NROM)**, which provides fixed or mirrored PRG/CHR banks with no bank switching.

## NES Terminology Definitions

* **iNES Header: 16-byte header format defining ROM structure
* **PRG ROM: Program ROM, mapped to CPU address space ($8000–$FFFF)
* **CHR ROM: Character ROM, mapped to PPU address space ($0000–$1FFF)
* **Mapper: Cartridge hardware that performs bank switching
* **Mapper 0 (NROM): Simplest mapper, no bank switching
* **Bank: Contiguous block of ROM (typically 8 KB PRG, 8 KB CHR)
* **Mirroring: Duplicating ROM banks to fill address space

## Core Rules and Invariants

### iNES Header

The iNES header (16 bytes) structure:

| Offset | Size | Description |
|--------|------|-------------|
| 0–3 | 4 | Magic: "NES" + $1A |
| 4 | 1 | PRG ROM size (16 KB units) |
| 5 | 1 | CHR ROM size (8 KB units, 0 = CHR RAM) |
| 6 | 1 | Flags 6: Mapper low, mirroring, battery, trainer |
| 7 | 1 | Flags 7: Mapper high, VS/Playchoice, NES 2.0 |
| 8 | 1 | PRG RAM size (8 KB units, rarely used) |
| 9 | 1 | TV system (0=NTSC, 1=PAL) |
| 10 | 6 | Unused (should be 0) |

Key flags in byte 6:
* Bit 0: Mirroring (0=horizontal, 1=vertical)
* Bit 1: Battery-backed PRG RAM
* Bit 2: Trainer present (512 bytes before PRG ROM)
* Bit 3: Ignore mirroring (use 4-screen VRAM)
* Bits 4–7: Mapper number (low 4 bits)

### PRG ROM vs CHR ROM

* **PRG ROM: Contains CPU code/data, mapped to $8000–$FFFF
  - Typical sizes: 16 KB, 32 KB, 128 KB, 256 KB, 512 KB
  - If 16 KB: mirrored to both $8000–$BFFF and $C000–$FFFF
  - If 32 KB: $8000–$FFFF (no mirroring)
* **CHR ROM: Contains PPU pattern data, mapped to $0000–$1FFF
  - Typical sizes: 8 KB, 16 KB, 32 KB, 128 KB
  - Always 8 KB visible at once (pattern tables 0 and 1)

### Mapper 0 (NROM) Mental Model

Mapper 0 is the simplest mapper:

* **16 KB PRG: 
  - Bank at $8000–$BFFF
  - Same bank mirrored at $C000–$FFFF
* **32 KB PRG:
  - Bank at $8000–$FFFF (no mirroring)
* **8 KB CHR:
  - Fixed at $0000–$1FFF
* **16 KB CHR:
  - First 8 KB at $0000–$0FFF
  - Second 8 KB at $1000–$1FFF
* **No bank switching: ROM is fixed in address space

### ROM File Layout

```
[0x0000] iNES Header (16 bytes)
[0x0010] Trainer (512 bytes, if present)
[0x0210] PRG ROM (16 KB × PRG_SIZE)
[0x4210] CHR ROM (8 KB × CHR_SIZE, if CHR_SIZE > 0)
```

## Minimal Correct Usage Example

```asm
; iNES header for 32 KB PRG, 8 KB CHR, Mapper 0, horizontal mirroring
.segment "HEADER"
    .byte "NES", $1A    ; Magic
    .byte 2             ; 32 KB PRG (2 × 16 KB)
    .byte 1             ; 8 KB CHR (1 × 8 KB)
    .byte %00000000     ; Mapper 0, horizontal mirroring, no battery
    .byte %00000000     ; Mapper 0 (high), NES format
    .byte 0             ; PRG RAM size
    .byte 0             ; NTSC
    .byte 0, 0, 0, 0, 0, 0  ; Unused

; Reset vector points to reset handler
.segment "VECTORS"
    .addr nmi, reset, irq

; PRG ROM code
.segment "CODE"
reset:
    ; ... initialization ...

; CHR ROM data (tiles)
.segment "CHARS"
    .incbin "tiles.chr"
```

## Gold Standard Example

```asm
; Complete iNES header and ROM structure example
.segment "HEADER"
    .byte "NES", $1A    ; iNES magic number
    .byte 2             ; 32 KB PRG ROM (2 * 16 KB)
    .byte 1             ; 8 KB CHR ROM (1 * 8 KB)
    .byte %00000000     ; Mapper 0, horizontal mirroring, no battery
    .byte %00000000     ; Mapper 0 (high), NES format
    .byte 0             ; PRG RAM size (0 = no battery RAM)
    .byte 0             ; TV system (0 = NTSC, 1 = PAL)
    .byte 0, 0, 0, 0, 0, 0  ; Unused bytes (must be 0)

; Interrupt vectors (must be at $FFFA-$FFFF)
.segment "VECTORS"
    .addr nmi, reset, irq

; PRG ROM code (mapped to $8000-$FFFF)
.segment "CODE"
    ; Code starts here
    .org $8000

reset:
    ; Reset handler code
    SEI
    CLD
    ; ... initialization ...
    JMP main_loop

nmi:
    ; NMI handler code
    RTI

irq:
    ; IRQ handler code
    RTI

main_loop:
    ; Main game loop
    JMP main_loop

; Data in PRG ROM
palette_data:
    .byte $0F, $30, $10, $00  ; Background palette 0
    .byte $0F, $30, $10, $00  ; Background palette 1
    .byte $0F, $30, $10, $00  ; Background palette 2
    .byte $0F, $30, $10, $00  ; Background palette 3
    .byte $0F, $16, $27, $18  ; Sprite palette 0
    .byte $0F, $16, $27, $18  ; Sprite palette 1
    .byte $0F, $16, $27, $18  ; Sprite palette 2
    .byte $0F, $16, $27, $18  ; Sprite palette 3

; CHR ROM data (mapped to PPU $0000-$1FFF)
.segment "CHARS"
    .incbin "graphics.chr"    ; 8 KB CHR ROM file
```

## Validation Rules

### iNES Header Rules

1. **Magic Number: First 4 bytes must be "NES" + $1A
2. **PRG ROM Size: Must match actual PRG ROM size (16 KB units)
3. **CHR ROM Size: Must match actual CHR ROM size (8 KB units, 0 = CHR RAM)
4. **Mapper Number: Must correctly identify mapper hardware
5. **Mirroring: Must match cartridge mirroring configuration
6. **Battery Flag: Must be set if cartridge has battery-backed RAM
7. **TV System: Must match target region (NTSC vs PAL)
8. **Unused Bytes: Bytes 8-15 must be 0

### ROM Structure Rules

1. **Header Location: iNES header must be at start of ROM file
2. **Vector Location: Interrupt vectors must be at $FFFA-$FFFF
3. **Code Location: PRG ROM code must be at $8000-$FFFF
4. **CHR Location: CHR ROM data must be at PPU $0000-$1FFF
5. **Size Matching: Actual ROM size must match header values
6. **Mapper Compatibility: Code must match mapper capabilities

### Failure Modes

* **Invalid Magic Number: Emulator rejects ROM file
* **Size Mismatch: ROM size doesn't match header, causes loading errors
* **Wrong Mapper: Code assumes wrong mapper capabilities, crashes
* **Missing Vectors: Interrupts jump to wrong address, system crashes
* **CHR Size Error: PPU pattern tables incorrect, graphics corrupted
* **Mirroring Mismatch: Background rendering incorrect, screen misaligned

## Explicit Non-Goals

This section does not cover:
* Advanced mappers (MMC1, MMC3, etc.)
* Bank switching techniques
* CHR RAM usage
* PRG RAM (save data) handling
* ROM file format details beyond iNES header
* Advanced mapper details beyond Mapper 0

## Cross-References

- Related Fundamentals: 1.1 (System Overview), 1.3 (Memory), 1.4 (PPU)
- Related Advanced Fundamentals: None (ROM is static)
- Related Core Concepts: None (ROM is data, not a system)
- Related Cheatsheets: None (ROM format is tooling-specific)
