# 1.5 ROM Fundamentals

## System Applicability

**This document applies to:**
- âœ… **SNES: Primary focus (cartridge-based ROM)

## Physical Hardware Overview

SNES cartridges contain:

* **ROM: Program and graphics data
* **Optional SRAM: Battery-backed save RAM
* **Enhancement chips: Optional chips (DSP, SA-1, Super FX, etc.)
* **ROM header: Metadata at start of ROM file

The simplest cartridge uses **LoROM** or **HiROM** mapping with no enhancement chips.

## SNES Terminology Definitions

* **LoROM: ROM mapping mode (banks $00-$7F, $80-$FF)
* **HiROM: ROM mapping mode (banks $C0-$FF)
* **Bank: 64KB address space (256 banks total)
* **SRAM: Static RAM, battery-backed save memory
* **Enhancement Chip: Optional cartridge chip (DSP, SA-1, Super FX, etc.)
* **ROM Header: Metadata at start of ROM file

## Core Rules and Invariants

### ROM Mapping

* **LoROM: ROM at banks $00-$7F and $80-$FF
  - Even banks: $8000-$FFFF
  - Odd banks: $0000-$7FFF (mirror of even banks)
* **HiROM: ROM at banks $C0-$FF
  - All banks: $8000-$FFFF
  - More efficient use of address space

### ROM Header

* Game title
* ROM/RAM size
* Region code
* Checksum
* Interrupt vectors

## Minimal Correct Usage Example

```asm
.segment "HEADER"
    ; ROM header at $FFB0 (HiROM) or $7FB0 (LoROM)
    .byte $20                    ; ROM type
    .byte $00                    ; ROM size
    .byte $00                    ; SRAM size
    .byte $00                    ; Region (NTSC)
    .byte $00                    ; Licensee
    .byte $00                    ; Version
    .byte $00, $00              ; Checksum complement
    .byte $00, $00              ; Checksum

; Interrupt vectors
.segment "VECTORS"
    .addr nmi, reset, irq

; ROM code
.segment "CODE"
    .org $C00000  ; HiROM bank $C0

reset:
    ; Reset handler
    SEI
    REP #$38
    XCE
    ; ... initialization ...
    JMP main_loop

nmi:
    ; NMI handler
    RTI

irq:
    ; IRQ handler
    RTI
```

## Gold Standard Example

```asm
.segment "HEADER"
    .org $FFB0
    .byte $20                  ; ROM type (HiROM + FastROM)
    .byte $05                  ; ROM size (32 Mbit = 4 MB)
    .byte $01                  ; SRAM size (64 KB)
    .byte $00                  ; Region (NTSC)
    .byte $33                  ; Licensee code
    .byte $00                  ; Version number
    .word $0000                ; Checksum complement
    .word $0000                ; Checksum
    .addr $0000, $0000         ; Unused
    .addr nmi, reset, irq      ; Interrupt vectors
    .addr $0000, $0000         ; Unused
    .byte $00                  ; Expansion RAM size
    .byte $00                  ; Special version
    .byte $00                  ; Special version complement

; Interrupt vectors
.segment "VECTORS"
    .org $FFE4
    .addr $0000                ; COP
    .addr $0000                ; BRK
    .addr $0000                ; ABORT
    .addr nmi                  ; NMI
    .addr $0000                ; Unused
    .addr irq                  ; IRQ
    .addr $0000, $0000         ; Unused

; Reset vector
    .org $FFFC
    .addr reset

; ROM code (HiROM bank $C0)
.segment "CODE"
    .org $C00000

reset:
    ; Complete reset handler
    SEI
    CLD
    REP #$38
    XCE
    ; ... initialization ...
    JMP main_loop

nmi:
    ; NMI handler
    RTI

irq:
    ; IRQ handler
    RTI

main_loop:
    ; Main game loop
    JMP main_loop
```

## Validation Rules

### ROM Header Rules

1. **Header Location: Header must be at correct offset ($FFB0 for HiROM, $7FB0 for LoROM)
2. **Title Length: Title must be exactly 21 bytes
3. **ROM Size: Must match actual ROM size
4. **SRAM Size: Must match actual SRAM size (if present)
5. **Region Code: Must match target region (NTSC vs PAL)
6. **Checksum: Must be calculated correctly
7. **Vectors: Interrupt vectors must point to valid handlers

### ROM Structure Rules

1. **Bank Organization: Code must match ROM mapping mode (LoROM/HiROM)
2. **Vector Location: Interrupt vectors must be at $FFE4-$FFFF (HiROM) or $7FE4-$7FFF (LoROM)
3. **Reset Vector: Reset vector must point to reset handler
4. **Code Location: Code must be in correct bank for mapping mode
5. **Size Matching: Actual ROM size must match header values

### Failure Modes

* **Invalid Header: Emulator rejects ROM file
* **Size Mismatch: ROM size doesn't match header, causes loading errors
* **Wrong Mapping: Code assumes wrong ROM mapping, crashes
* **Missing Vectors: Interrupts jump to wrong address, system crashes
* **Checksum Error: ROM validation fails, emulator may reject file

## Explicit Non-Goals

This section does not cover:
* Enhancement chip details (DSP, SA-1, Super FX)
* Advanced ROM mapping techniques
* SRAM save/load implementation
* ROM file format details beyond header
* Compression techniques

## Cross-References

- Related Advanced Fundamentals: None (ROM is static)
- Related Core Concepts: None (ROM is data, not a system)
- Related Cheatsheets: None (ROM format is tooling-specific)
