# 1.2 LR35902 CPU Fundamentals

## System Applicability

**This document applies to:**
- ✅ **Game Boy (DMG): Primary focus
- ✅ **Game Boy Color (CGB): Fully compatible (same CPU)
- ❌ **NES/SNES: Does not apply (different CPU architecture)

## Physical Hardware Overview

The LR35902 is a custom CPU based on the Z80 architecture, modified for Game Boy hardware. It operates at approximately 4.19 MHz (DMG) or 8.39 MHz (CGB double-speed mode).

Key features:
* 8-bit data bus
* 16-bit address bus (64 KB address space)
* Z80-like instruction set with Game Boy-specific modifications
* No decimal mode (unlike 6502)
* Interrupt system (VBlank, LCD STAT, Timer, Serial, Joypad)

## Game Boy Terminology Definitions

* **Register: CPU storage location (A, B, C, D, E, H, L, SP, PC, F)
* **Flag: Status bit in F register (Z, N, H, C)
* **Interrupt: Hardware event that pauses execution
* **VBlank Interrupt: Fires at start of VBlank (scanline 144)
* **LCD STAT Interrupt: Fires on LCD mode changes
* **Timer Interrupt: Fires when timer overflows
* **Serial Interrupt: Fires when serial transfer completes
* **Joypad Interrupt: Fires on button press (CGB only)

## Core Rules and Invariants

### Registers

* **A: Accumulator (8-bit, primary arithmetic register)
* **F: Flags register (8-bit, Z N H C flags)
* **B, C, D, E, H, L: General-purpose registers (8-bit each)
* **BC, DE, HL: Register pairs (16-bit, B+C, D+E, H+L)
* **SP: Stack pointer (16-bit, points to WRAM)
* **PC: Program counter (16-bit, points to ROM)

### Flags

* **Z: Zero flag (set when result is zero)
* **N: Subtract flag (set after subtraction)
* **H: Half-carry flag (set on 4-bit carry)
* **C: Carry flag (set on 8-bit carry/borrow)

### Memory Access

* CPU can access entire 64 KB address space
* ROM: $0000-$7FFF (32 KB, banked with MBC)
* VRAM: $8000-$9FFF (8 KB, restricted during certain LCD modes)
* WRAM: $C000-$DFFF (8 KB)
* OAM: $FE00-$FE9F (160 bytes, restricted during certain LCD modes)
* I/O: $FF00-$FF7F (I/O registers)
* HRAM: $FF80-$FFFE (128 bytes, always accessible)

## Minimal Correct Usage Example

```asm
; Basic register operations
ld a, $42        ; Load immediate value
ld b, a          ; Copy A to B
add a, $10       ; Add immediate (sets flags)
jr z, zero       ; Jump if zero flag set
ld hl, $C000     ; Load 16-bit address
ld [hl], a       ; Store A to address in HL
```

## Gold Standard Example

```asm
; Complete LR35902 usage example
SECTION "Code", ROM0[$0150]

; Register operations
example_registers:
    ; 8-bit operations
    ld a, $42        ; Load immediate
    ld b, a          ; Copy register
    add a, $10       ; Arithmetic (sets Z, H, C flags)
    sub $20          ; Subtraction (sets Z, N, H, C flags)
    and $0F          ; Logical AND (sets Z, H flags)
    or $F0           ; Logical OR (sets Z flag)
    xor a            ; Clear A and Z flag
    
    ; 16-bit operations
    ld hl, $C000     ; Load 16-bit immediate
    ld de, $D000     ; Load 16-bit immediate
    add hl, de       ; 16-bit addition (sets H, C flags)
    ld sp, hl        ; Set stack pointer
    
    ; Memory access
    ld [hl], a       ; Store A to address in HL
    ld a, [hl]       ; Load A from address in HL
    ld [hl+], a      ; Store and increment HL
    ld a, [hl+]      ; Load and increment HL
    ld [hl-], a      ; Store and decrement HL
    ld a, [hl-]      ; Load and decrement HL
    
    ; Stack operations
    push af          ; Push AF (A and flags)
    pop bc           ; Pop to BC
    push hl          ; Push HL
    pop de           ; Pop to DE
    
    ; Control flow
    call subroutine  ; Call subroutine
    ret              ; Return from subroutine
    jp $8000         ; Absolute jump
    jr .label        ; Relative jump
    jr z, .zero      ; Conditional relative jump
    
    ; Interrupts
    ei               ; Enable interrupts
    di               ; Disable interrupts
    reti             ; Return from interrupt (enables interrupts)
    
    ret

subroutine:
    ; Subroutine code
    ret

.label:
.zero:
    ret
```

## Validation Rules

### Register Usage Rules

1. **Flag Preservation: Flags are modified by most arithmetic/logical operations
2. **Register Pairs: BC, DE, HL are 16-bit pairs (B+C, D+E, H+L)
3. **Stack Operations: SP must point to valid WRAM ($C000-$DFFF)
4. **Memory Access: Address must be in valid range for operation
5. **Interrupt Safety: Critical sections must disable interrupts

### Failure Modes

* **Uninitialized Stack: Stack operations corrupt memory
* **Flag Assumptions: Assuming flags are unchanged when they're not
* **Memory Access Violations: Accessing restricted memory during LCD modes
* **Interrupt Race Conditions: Data corruption from interrupt handlers

## Cross-References

- Related Fundamentals: 1.1 (Game Boy System Overview), 1.3 (Memory Fundamentals)
- Related Advanced Fundamentals: 2.1 (CPU Timing), 2.4 (Interrupt System)
