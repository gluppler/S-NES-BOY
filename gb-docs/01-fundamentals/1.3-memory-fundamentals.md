# 1.3 Game Boy Memory Fundamentals

## System Applicability

**This document applies to:**
- ✅ **Game Boy (DMG): Primary focus
- ✅ **Game Boy Color (CGB): Differences explicitly labeled
- ❌ **NES/SNES: Does not apply (different memory architecture)

## Physical Hardware Overview

The Game Boy CPU (LR35902) has a 16-bit address bus, providing 64 KB ($0000-$FFFF) of addressable space. This space is divided into:

* **ROM: Cartridge ROM (banks $00-$7F, expandable with MBC)
* **VRAM: Video RAM (8 KB, $8000-$9FFF)
* **WRAM: Work RAM (8 KB, $C000-$DFFF)
* **OAM: Object Attribute Memory (160 bytes, $FE00-$FE9F)
* **I/O Registers: Hardware registers ($FF00-$FF7F)
* **HRAM: High RAM (128 bytes, $FF80-$FFFE)

The PPU has its own address space separate from the CPU bus for VRAM and OAM.

## Game Boy Terminology Definitions

* **Memory Map: The 64 KB address space visible to the CPU
* **Bank: Switchable ROM/RAM region (controlled by MBC)
* **MBC: Memory Bank Controller (cartridge mapper chip)
* **VRAM: Video RAM, 8 KB for tiles and tilemaps
* **WRAM: Work RAM, 8 KB for program data
* **OAM: Object Attribute Memory, 160 bytes for sprites
* **HRAM: High RAM, 128 bytes for fast access
* **Mirror: Duplicate memory region (WRAM mirrors at $E000-$FDFF)

## Core Rules and Invariants

### CPU Memory Map ($0000-$FFFF)

| Address Range | Size | Description | Notes |
|--------------|------|-------------|-------|
| $0000-$3FFF | 16 KB | ROM Bank 0 | Fixed, always accessible |
| $4000-$7FFF | 16 KB | ROM Bank N | Switchable with MBC |
| $8000-$9FFF | 8 KB | VRAM | Restricted during LCD modes 3 |
| $A000-$BFFF | 8 KB | External RAM | MBC-controlled, optional |
| $C000-$CFFF | 4 KB | WRAM Bank 0 | Fixed |
| $D000-$DFFF | 4 KB | WRAM Bank 1 | Switchable on CGB |
| $E000-$FDFF | 8 KB | WRAM Mirror | Mirror of $C000-$DFFF |
| $FE00-$FE9F | 160 B | OAM | Restricted during LCD modes 2-3 |
| $FEA0-$FEFF | 96 B | Unusable | Do not access |
| $FF00-$FF7F | 128 B | I/O Registers | Hardware registers |
| $FF80-$FFFE | 127 B | HRAM | Fast access, always available |
| $FFFF | 1 B | IE Register | Interrupt enable |

### VRAM Access Restrictions

* **Mode 0 (HBlank): VRAM accessible
* **Mode 1 (VBlank): VRAM accessible
* **Mode 2 (OAM Search): VRAM accessible
* **Mode 3 (Pixel Transfer): VRAM NOT accessible

### OAM Access Restrictions

* **Mode 0 (HBlank): OAM accessible
* **Mode 1 (VBlank): OAM accessible
* **Mode 2 (OAM Search): OAM NOT accessible
* **Mode 3 (Pixel Transfer): OAM NOT accessible

## Minimal Correct Usage Example

```asm
; Memory access examples
ld a, [$C000]    ; Read from WRAM
ld [$C000], a    ; Write to WRAM
ld hl, $C000     ; Set pointer
ld [hl], a       ; Indirect write
ld a, [hl+]      ; Indirect read and increment
ld a, [$FF80]    ; Read from HRAM (fast)
ld [$FF80], a    ; Write to HRAM (fast)
```

## Gold Standard Example

```asm
; Complete Game Boy memory usage example
SECTION "Code", ROM0[$0150]

; WRAM usage
example_wram:
    ld hl, $C000     ; WRAM base address
    ld a, $42
    ld [hl], a       ; Store to WRAM
    ld a, [hl]       ; Load from WRAM
    
    ; WRAM variable storage
    ld hl, w_variable
    ld a, $10
    ld [hl], a
    
    ret

; HRAM usage (fast access)
example_hram:
    ld a, $42
    ld [$FF80], a    ; Store to HRAM
    ld a, [$FF80]    ; Load from HRAM
    
    ; HRAM is faster than WRAM (1 cycle vs 2 cycles)
    ret

; VRAM access (must respect LCD modes)
example_vram:
    ; Wait for VBlank (Mode 1) - safe for VRAM access
    call wait_vblank
    
    ; Write to VRAM
    ld hl, $8000     ; VRAM tile data
    ld a, $FF
    ld [hl+], a      ; Write and increment
    
    ret

; OAM access (must respect LCD modes)
example_oam:
    ; Wait for VBlank (Mode 1) - safe for OAM access
    call wait_vblank
    
    ; Write to OAM
    ld hl, $FE00     ; OAM base
    ld a, $10        ; Y position
    ld [hl+], a
    ld a, $08        ; X position
    ld [hl+], a
    ld a, $00        ; Tile number
    ld [hl+], a
    ld a, $00        ; Attributes
    ld [hl], a
    
    ret

wait_vblank:
    ld a, [rLY]
    cp 144
    jr c, wait_vblank
    ret

; WRAM variables
SECTION "WRAM", WRAM0[$C000]
w_variable:
    ds 1
```

## Validation Rules

### Memory Access Rules

1. **VRAM Access: Only during Mode 0 (HBlank) or Mode 1 (VBlank)
2. **OAM Access: Only during Mode 0 (HBlank) or Mode 1 (VBlank)
3. **HRAM Access: Always accessible (fastest memory)
4. **WRAM Access: Always accessible (except during power-down)
5. **ROM Access: Always accessible (bank switching with MBC)
6. **I/O Registers: Access timing may be restricted (see register documentation)

### Failure Modes

* **VRAM Access During Mode 3: Causes corruption, incorrect tiles
* **OAM Access During Mode 2-3: Causes sprite glitches, corruption
* **Uninitialized Memory: Variables contain garbage values
* **Stack Overflow: Stack grows into other memory regions
* **Bank Switching Errors: Accessing wrong ROM/RAM bank

## Cross-References

- Related Fundamentals: 1.1 (Game Boy System Overview), 1.2 (LR35902 CPU)
- Related Advanced Fundamentals: 2.2 (LCD Controller Modes), 2.3 (Memory Access Restrictions)
