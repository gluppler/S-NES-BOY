# 2.1 Instruction Timing

## System Applicability

**This document applies to:**
- ✅ **Game Boy (DMG): Primary focus
- ✅ **Game Boy Color (CGB): Fully compatible (same CPU timing)
- ❌ **NES/SNES: Does not apply (different CPU architecture)

## Physical Hardware Overview

The LR35902 CPU operates at approximately 4.19 MHz (DMG) or 8.39 MHz (CGB double-speed mode). Each instruction requires a specific number of CPU cycles to execute. Timing is critical for:

* Synchronization with LCD controller
* DMA transfers
* Timer operations
* Serial communication
* Audio processing

## Game Boy Terminology Definitions

* **Cycle: One CPU clock cycle (~238 ns at 4.19 MHz)
* **M-Cycle: Machine cycle (4 CPU cycles)
* **Instruction Time: Total cycles required for instruction execution
* **Memory Access: Additional cycles for memory operations
* **Branch Penalty: Extra cycles for taken branches

## Core Rules and Invariants

### Timing Characteristics

* Most instructions execute in 4-16 cycles
* Memory access adds cycles (2 cycles for WRAM, 1 cycle for HRAM)
* Branch instructions: 8 cycles (not taken), 12 cycles (taken)
* Interrupt handling: ~20 cycles overhead
* HALT instruction: CPU stops until interrupt (saves power)

### Critical Timing Windows

* **VBlank: ~4560 cycles (10 scanlines × 456 cycles/scanline)
* **HBlank: ~204 cycles (per scanline, varies)
* **OAM DMA: 160 cycles (transfers 160 bytes)
* **LCD Mode 3: ~172 cycles (pixel transfer, VRAM locked)

## Minimal Correct Usage Example

```asm
; Timing-aware code
timing_example:
    ld a, $42        ; 4 cycles
    ld [$C000], a    ; 4 cycles (instruction) + 2 cycles (WRAM write) = 6 cycles
    ld [$FF80], a    ; 4 cycles (instruction) + 1 cycle (HRAM write) = 5 cycles
    jr .label        ; 8 cycles (not taken) or 12 cycles (taken)
.label:
    ret              ; 4 cycles (instruction) + 4 cycles (return) = 8 cycles
```

## Gold Standard Example

```asm
; Complete timing-aware Game Boy code example
SECTION "Code", ROM0[$0150]

; Instruction timing reference
timing_reference:
    ; Register operations (4 cycles)
    ld a, b          ; 4 cycles
    ld b, a          ; 4 cycles
    add a, b         ; 4 cycles
    sub b            ; 4 cycles
    and b            ; 4 cycles
    or b             ; 4 cycles
    xor b            ; 4 cycles
    
    ; Immediate operations (8 cycles)
    ld a, $42        ; 8 cycles
    add a, $10       ; 8 cycles
    
    ; Memory operations
    ld a, [$C000]    ; 12 cycles (4 instruction + 2 WRAM read + 6 overhead)
    ld [$C000], a    ; 12 cycles (4 instruction + 2 WRAM write + 6 overhead)
    ld a, [$FF80]    ; 8 cycles (4 instruction + 1 HRAM read + 3 overhead)
    ld [$FF80], a    ; 8 cycles (4 instruction + 1 HRAM write + 3 overhead)
    
    ; 16-bit operations
    ld hl, $C000     ; 12 cycles
    ld [hl], a       ; 8 cycles
    ld a, [hl+]      ; 8 cycles
    inc hl           ; 8 cycles
    dec hl           ; 8 cycles
    add hl, bc       ; 8 cycles
    
    ; Control flow
    jp $8000         ; 4 cycles (instruction) + 4 cycles (jump) = 8 cycles
    jr .label        ; 8 cycles (not taken) or 12 cycles (taken)
    call subroutine  ; 6 cycles (instruction) + 12 cycles (call) = 18 cycles
    ret              ; 4 cycles (instruction) + 12 cycles (return) = 16 cycles
    
    ; Conditional branches
    jr z, .zero      ; 8 cycles (not taken) or 12 cycles (taken)
    jr nz, .nonzero  ; 8 cycles (not taken) or 12 cycles (taken)
    
.label:
.zero:
.nonzero:
    ret

subroutine:
    ret
```

## Validation Rules

### Timing Requirements

1. **Memory Access: WRAM access is slower than HRAM (2 cycles vs 1 cycle)
2. **Branch Penalty: Taken branches cost 4 extra cycles
3. **Interrupt Overhead: Interrupt handling adds ~20 cycles
4. **DMA Timing: OAM DMA takes 160 cycles (blocks CPU)

### Failure Modes

* **Timing Assumptions: Assuming instructions take same time regardless of operands
* **Memory Access Ignorance: Not accounting for memory access cycles
* **Branch Timing: Assuming branches always take same time
* **Interrupt Timing: Not accounting for interrupt overhead

## Cross-References

- Related Fundamentals: 1.2 (LR35902 CPU Fundamentals)
- Related Advanced Fundamentals: 2.2 (LCD Controller Modes), 2.3 (Memory Access Restrictions)
