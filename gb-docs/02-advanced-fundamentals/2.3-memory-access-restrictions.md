# 2.3 Memory Access Restrictions

## System Applicability

**This document applies to:**
- ✅ **Game Boy (DMG): Primary focus
- ✅ **Game Boy Color (CGB): Differences explicitly labeled
- ❌ **NES/SNES: Does not apply (different memory architecture)

## Physical Hardware Overview

The Game Boy memory map has access restrictions based on LCD controller mode. VRAM and OAM are locked during certain rendering phases to prevent corruption of active rendering data.

Access restrictions:
* **VRAM ($8000-$9FFF): Locked during Mode 3 (Pixel Transfer)
* **OAM ($FE00-$FE9F): Locked during Mode 2 (OAM Search) and Mode 3 (Pixel Transfer)
* **HRAM ($FF80-$FFFE): Always accessible (fastest memory)
* **WRAM ($C000-$DFFF): Always accessible
* **I/O Registers ($FF00-$FF7F): Access timing may be restricted

## Game Boy Terminology Definitions

* **VRAM Lock: VRAM inaccessible during Mode 3
* **OAM Lock: OAM inaccessible during Mode 2-3
* **Access Window: Period when memory is accessible
* **Corruption: Data corruption from accessing locked memory
* **Safe Access: Memory access during allowed LCD modes

## Core Rules and Invariants

### VRAM Access Rules

* **Mode 0 (HBlank): VRAM accessible
* **Mode 1 (VBlank): VRAM accessible
* **Mode 2 (OAM Search): VRAM accessible
* **Mode 3 (Pixel Transfer): VRAM NOT accessible

### OAM Access Rules

* **Mode 0 (HBlank): OAM accessible
* **Mode 1 (VBlank): OAM accessible
* **Mode 2 (OAM Search): OAM NOT accessible
* **Mode 3 (Pixel Transfer): OAM NOT accessible

### Access Timing

* **VBlank Window: ~4560 cycles (10 scanlines × 456 cycles)
* **HBlank Window: ~87-204 cycles per scanline (varies)
* **Total Safe Time: ~4560 cycles (VBlank) + ~14400 cycles (HBlank) = ~18960 cycles per frame

## Minimal Correct Usage Example

```asm
; Safe VRAM access
safe_vram:
    call wait_vblank  ; Wait for Mode 1
    ld hl, $8000
    ld a, $FF
    ld [hl], a        ; Safe to write
    ret

; Unsafe VRAM access (DO NOT DO THIS)
unsafe_vram:
    ld hl, $8000
    ld a, $FF
    ld [hl], a        ; May corrupt if Mode 3
    ret
```

## Gold Standard Example

```asm
; Complete memory access restriction handling
SECTION "Code", ROM0[$0150]

; Wait for VBlank (Mode 1) - safe for all memory
wait_vblank:
    ; Per Pan Docs: VBlank starts at scanline 144
    ld a, [rLY]
    cp 144
    jr c, wait_vblank
    ret

; Wait for HBlank (Mode 0) - safe for all memory
wait_hblank:
    ; Per Pan Docs: Check STAT register
    ld a, [rSTAT]
    and %00000011   ; Mode bits
    cp 0            ; Mode 0?
    jr nz, wait_hblank
    ret

; Safe VRAM write (Mode 0 or Mode 1 only)
safe_vram_write:
    ; Wait for safe mode
    call wait_vblank
    
    ; Now safe to write to VRAM
    ld hl, $8000
    ld bc, $1000    ; 4 KB
    xor a
.loop:
    ld [hl+], a
    dec bc
    ld a, b
    or c
    jr nz, .loop
    
    ret

; Safe OAM write (Mode 0 or Mode 1 only)
safe_oam_write:
    ; Wait for safe mode
    call wait_vblank
    
    ; Now safe to write to OAM
    ld hl, $FE00
    ld bc, $00A0    ; 160 bytes
    xor a
.loop:
    ld [hl+], a
    dec bc
    ld a, b
    or c
    jr nz, .loop
    
    ret

; Safe VRAM read (Mode 0 or Mode 1 only)
safe_vram_read:
    ; Wait for safe mode
    call wait_vblank
    
    ; Now safe to read from VRAM
    ld hl, $8000
    ld a, [hl]
    
    ret

; HRAM access (always safe, fastest)
fast_hram_write:
    ; HRAM is always accessible
    ld a, $42
    ld [$FF80], a   ; Fast write (1 cycle)
    
    ret

; WRAM access (always safe)
wram_write:
    ; WRAM is always accessible
    ld a, $42
    ld [$C000], a   ; WRAM write (2 cycles)
    
    ret
```

## Validation Rules

### Memory Access Requirements

1. **VRAM Access: Only during Mode 0 (HBlank) or Mode 1 (VBlank)
2. **OAM Access: Only during Mode 0 (HBlank) or Mode 1 (VBlank)
3. **Mode Check: Must verify LCD mode before accessing restricted memory
4. **VBlank Wait: Use scanline 144 check for VBlank
5. **HBlank Wait: Use STAT register for Mode 0 detection

### Failure Modes

* **VRAM Access During Mode 3: Causes tile corruption, visual glitches
* **OAM Access During Mode 2-3: Causes sprite corruption, missing sprites
* **Missing Mode Check: Undefined behavior, data corruption
* **Incorrect Timing: Accessing memory at wrong time causes corruption

## Cross-References

- Related Fundamentals: 1.3 (Memory Fundamentals)
- Related Advanced Fundamentals: 2.2 (LCD Controller Modes), 2.4 (Interrupt System)
- Related Core Concepts: 3.2 (Rendering Pipeline)
