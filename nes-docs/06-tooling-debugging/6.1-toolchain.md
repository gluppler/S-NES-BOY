# 6.1 Toolchain (Linux-first)

## System Applicability

**This document applies to:
- ✅ **NES: Primary focus (ca65/ld65 for 6502)
- ✅ **: Fully compatible (same toolchain)
- ⚠️ **SNES: Partially applicable (ca65 supports 65816, but SNES development may require additional tools)

**Note: ca65 supports 65816 CPU (SNES), but SNES development may require additional tools for SPC700 audio and SNES-specific features. This document focuses on NES/ toolchain.

## ca65 / ld65

**ca65** is the assembler, **ld65** is the linker. Part of the CC65 toolchain.

### Installation

```bash
# Debian/Ubuntu
sudo apt-get install cc65

# Arch Linux
sudo pacman -S cc65

# From source
git clone https://github.com/cc65/cc65.git
cd cc65
make
sudo make install
```

### Basic Usage

**Assembly file** (`game.asm`):
```asm
.segment "HEADER"
    .byte "NES", $1A
    .byte 2        ; 32 KB PRG
    .byte 1        ; 8 KB CHR
    .byte %00000000
    .byte %00000000
    .byte 0, 0, 0, 0, 0, 0

.segment "VECTORS"
    .addr nmi, reset, irq

.segment "CODE"
reset:
    SEI
    CLD
    ; ... initialization ...
    JMP main_loop

nmi:
    RTI

irq:
    RTI

.segment "CHARS"
    .incbin "tiles.chr"
```

**Linker configuration** (`game.cfg`):
```
MEMORY {
    HEADER: start = $0000, size = $0010, fill = yes;
    VECTORS: start = $FFFA, size = $0006;
    PRG: start = $8000, size = $8000, fill = yes;
    CHR: start = $0000, size = $2000;
}

SEGMENTS {
    HEADER: load = HEADER, type = ro;
    VECTORS: load = VECTORS, type = ro;
    CODE: load = PRG, type = rw;
    CHARS: load = CHR, type = ro;
}
```

**Build command:
```bash
ca65 game.asm -o game.o
ld65 -C game.cfg -o game.nes game.o
```

### Makefile Example

```makefile
CC65 = ca65
LD65 = ld65

SOURCES = game.asm
OBJECTS = $(SOURCES:.asm=.o)
TARGET = game.nes
CFG = game.cfg

all: $(TARGET)

$(TARGET): $(OBJECTS) $(CFG)
	$(LD65) -C $(CFG) -o $(TARGET) $(OBJECTS)

%.o: %.asm
	$(CC65) $< -o $@

clean:
	rm -f $(OBJECTS) $(TARGET)
```

## asm6f

**asm6f** is a single-pass assembler, simpler than ca65 but less features.

### Installation

```bash
# Download from https://github.com/freem/asm6f
git clone https://github.com/freem/asm6f.git
cd asm6f
make
sudo cp asm6f /usr/local/bin/
```

### Basic Usage

**Assembly file** (`game.asm`):
```asm
; iNES header
.db "NES", $1A
.db 2        ; 32 KB PRG
.db 1        ; 8 KB CHR
.db %00000000
.db %00000000
.db 0, 0, 0, 0, 0, 0

.org $8000
reset:
    sei
    cld
    ; ... initialization ...
    jmp main_loop

.org $FFFA
.dw nmi, reset, irq

nmi:
    rti

irq:
    rti
```

**Build command:
```bash
asm6f game.asm game.nes
```

## Makefiles

**Complete Makefile** (ca65):
```makefile
# NES Build System
AS = ca65
LD = ld65
CFG = game.cfg

SOURCES = game.asm
OBJECTS = $(SOURCES:.asm=.o)
TARGET = game.nes

.PHONY: all clean run

all: $(TARGET)

$(TARGET): $(OBJECTS) $(CFG)
	$(LD) -C $(CFG) -o $(TARGET) $(OBJECTS)

%.o: %.asm
	$(AS) $< -o $@

clean:
	rm -f $(OBJECTS) $(TARGET)

run: $(TARGET)
	mesen $(TARGET)
```

**Makefile with multiple files:
```makefile
AS = ca65
LD = ld65
CFG = game.cfg

SOURCES = main.asm player.asm enemy.asm level.asm
OBJECTS = $(SOURCES:.asm=.o)
TARGET = game.nes

all: $(TARGET)

$(TARGET): $(OBJECTS) $(CFG)
	$(LD) -C $(CFG) -o $(TARGET) $(OBJECTS)

%.o: %.asm
	$(AS) $< -o $@

clean:
	rm -f $(OBJECTS) $(TARGET)
```

## Common Build Issues

**Problem: "Undefined symbol" errors
- **Solution: Check segment definitions in `.cfg` file match `.segment` directives

**Problem: "Address out of range"
- **Solution: Check memory map in `.cfg` file, ensure segments fit

**Problem: "Overlapping segments"
- **Solution: Ensure segment addresses don't overlap in `.cfg` file

**Problem: ROM doesn't boot
- **Solution: Check iNES header, reset vector points to valid code

## Cross-References

- Related Fundamentals: 1.5 (ROM Fundamentals)
- Related Cheatsheets: None (tooling-specific)
