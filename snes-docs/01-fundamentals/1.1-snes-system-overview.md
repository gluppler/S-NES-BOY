# 1.1 SNES System Overview

## System Applicability

**This document applies to:
- ✅ **SNES (Super Nintendo Entertainment System): Primary focus
- ❌ **NES: Does not apply (different architecture - see NES-specific documentation)

## Physical Hardware Overview

The Super Nintendo Entertainment System (SNES) is a composite system consisting of:

* **Ricoh 5A22 CPU** (65816 variant, ~3.58 MHz NTSC, ~3.55 MHz PAL)
* **PPU** (Picture Processing Unit, two chips: PPU1 and PPU2)
* **SPC700** (Sound CPU, 8-bit processor for audio)
* **Cartridge slot** (connects ROM and optional enhancement chips)
* **128 KB WRAM** (Work RAM, CPU-accessible)
* **64 KB VRAM** (Video RAM, PPU-accessible)
* **512 bytes CGRAM** (Color Generator RAM, palette storage)
* **544 bytes OAM** (Object Attribute Memory, sprite data)

The CPU and PPU operate on separate buses. The CPU cannot directly access PPU memory; all communication occurs through memory-mapped I/O registers.

## SNES Terminology Definitions

* **NTSC: North American/Japanese video standard (60.098 Hz frame rate, 262 scanlines)
* **PAL: European video standard (50.007 Hz frame rate, 312 scanlines)
* **VBlank: Vertical blanking period when PPU is not rendering
* **Scanline: One horizontal line of video output
* **Frame: One complete screen refresh
* **NMI: Non-Maskable Interrupt, triggered at start of VBlank
* **DMA: Direct Memory Access for fast data transfers
* **HDMA: H-Blank DMA for per-scanline updates
* **LoROM: ROM mapping mode (banks $00-$7F, $80-$FF)
* **HiROM: ROM mapping mode (banks $C0-$FF)

## Core Rules and Invariants

* Everything revolves around **VBlank**. Safe PPU VRAM access occurs only during VBlank or forced blanking.
* The CPU runs at ~3.58 MHz (NTSC). One frame = ~59,640 CPU cycles.
* The PPU renders visible scanlines, then enters VBlank.
* NMI fires once per frame at the start of VBlank.
* CPU memory map includes WRAM, ROM, I/O registers, and cartridge space.
* PPU memory map: VRAM (tiles, name tables), CGRAM (palettes), OAM (sprites).

## Minimal Correct Usage Example

```asm
; Minimal SNES initialization
reset:
    SEI          ; Disable interrupts
    CLD          ; Clear decimal mode
    REP #$38     ; Set native mode, clear decimal
    XCE          ; Switch to native mode
    JMP init_snes

init_snes:
    ; Initialize CPU
    SEP #$30     ; 8-bit A, X, Y
    LDA #$8F     ; Force blank, screen off
    STA $2100    ; INIDISP
    STZ $2101    ; OBSEL
    STZ $2102    ; OAMADDL
    STZ $2103    ; OAMADDH
    
    ; Clear WRAM
    REP #$20     ; 16-bit A
    LDA #$0000
    TCD          ; Direct page = $0000
    LDX #$80
    STX $4300    ; DMA parameters
    STX $4310
    STX $4320
    LDA #$0000
    STA $2181    ; WRAM address low
    STZ $2183    ; WRAM address high
    LDA #$0008
    STA $4301    ; DMA destination
    LDA #$0000
    STA $4302    ; DMA source
    STZ $4304    ; DMA source bank
    LDA #$FFFF
    STA $4305    ; Transfer size
    LDX #$01
    STX $420B    ; Start DMA
    
    ; Initialize PPU
    SEP #$20     ; 8-bit A
    LDA #$80
    STA $2100    ; Screen on
    CLI          ; Enable interrupts
    
    JMP main_loop
```

## Gold Standard Example

```asm
; Complete SNES initialization following hardware requirements
reset:
    ; Disable interrupts
    SEI
    CLD
    
    ; Switch to native mode
    REP #$38     ; Native mode, clear decimal, clear accumulator
    XCE          ; Switch from emulation to native mode
    
    ; Initialize stack
    LDA #$01FF
    TCS          ; Stack pointer = $01FF
    
    ; Initialize direct page
    LDA #$0000
    TCD          ; Direct page = $0000
    
    ; Force blank
    SEP #$20     ; 8-bit accumulator
    LDA #$8F     ; Force blank, brightness = 0
    STA $2100    ; INIDISP
    
    ; Initialize PPU registers
    STZ $2101    ; OBSEL - Object size and base
    STZ $2102    ; OAMADDL - OAM address low
    STZ $2103    ; OAMADDH - OAM address high
    STZ $2105    ; BGMODE - Background mode
    STZ $2106    ; MOSAIC
    STZ $2107    ; BG1SC - BG1 screen base
    STZ $2108    ; BG2SC - BG2 screen base
    STZ $2109    ; BG3SC - BG3 screen base
    STZ $210A    ; BG4SC - BG4 screen base
    STZ $210B    ; BG12NBA - BG1/BG2 tile base
    STZ $210C    ; BG34NBA - BG3/BG4 tile base
    STZ $210D    ; BG1HOFS - BG1 horizontal scroll
    STZ $210D
    STZ $210E    ; BG1VOFS - BG1 vertical scroll
    STZ $210E
    STZ $210F    ; BG2HOFS
    STZ $210F
    STZ $2110    ; BG2VOFS
    STZ $2110
    STZ $2111    ; BG3HOFS
    STZ $2111
    STZ $2112    ; BG3VOFS
    STZ $2112
    STZ $2113    ; BG4HOFS
    STZ $2113
    STZ $2114    ; BG4VOFS
    STZ $2114
    STZ $2115    ; VMAIN - VRAM address increment
    STZ $2116    ; VMADDL - VRAM address low
    STZ $2117    ; VMADDH - VRAM address high
    STZ $211A    ; M7SEL
    STZ $211B    ; M7A
    LDA #$01
    STA $211B
    STZ $211C    ; M7B
    STZ $211C
    STZ $211D    ; M7C
    STZ $211D
    STZ $211E    ; M7D
    STZ $211E
    STZ $211F    ; M7X
    STZ $211F
    STZ $2120    ; M7Y
    STZ $2120
    STZ $2121    ; CGADD - CGRAM address
    STZ $2122    ; CGDATA - CGRAM data
    STZ $2123    ; W12SEL
    STZ $2124    ; W34SEL
    STZ $2125    ; WOBJSEL
    STZ $2126    ; WH0 - Window 0 left
    STZ $2127    ; WH1 - Window 0 right
    STZ $2128    ; WH2 - Window 1 left
    STZ $2129    ; WH3 - Window 1 right
    STZ $212A    ; WBGLOG
    STZ $212B    ; WOBJLOG
    STZ $212C    ; TM - Main screen designation
    STZ $212D    ; TS - Sub screen designation
    STZ $212E    ; TMW
    STZ $212F    ; TSW
    LDA #$30
    STA $2130    ; CGWSEL
    STZ $2131    ; CGADSUB
    LDA #$E0
    STA $2132    ; COLDATA
    STZ $2133    ; SETINI
    
    ; Clear WRAM using DMA
    REP #$20     ; 16-bit accumulator
    LDA #$0000
    STA $2181    ; WRAM address = $0000
    STZ $2183
    LDA #$8008
    STA $4300    ; DMA parameters: fixed source, write to WRAM
    LDA #$0000
    STA $4302    ; Source address = $0000
    STZ $4304    ; Source bank = $00
    LDA #$FFFF
    STA $4305    ; Transfer size = 64KB
    SEP #$20     ; 8-bit accumulator
    LDA #$01
    STA $420B    ; Start DMA channel 0
    
    ; Wait for DMA
    WAI
    
    ; Clear VRAM
    REP #$20
    LDA #$80
    STA $2115    ; VRAM increment = 1 word
    LDA #$0000
    STA $2116    ; VRAM address = $0000
    LDA #$1809
    STA $4300    ; DMA: fixed source, write to VRAM
    LDA #$0000
    STA $4302
    STZ $4304
    LDA #$FFFF
    STA $4305
    SEP #$20
    LDA #$01
    STA $420B
    
    ; Wait for DMA
    WAI
    
    ; Clear CGRAM
    STZ $2121    ; CGRAM address = $00
    REP #$20
    LDA #$2002
    STA $4300    ; DMA: fixed source, write to CGRAM
    LDA #$0000
    STA $4302
    STZ $4304
    LDA #$0200
    STA $4305    ; Transfer 512 bytes
    SEP #$20
    LDA #$01
    STA $420B
    
    ; Wait for DMA
    WAI
    
    ; Clear OAM
    STZ $2102    ; OAM address = $00
    STZ $2103
    REP #$20
    LDA #$0402
    STA $4300    ; DMA: fixed source, write to OAM
    LDA #$0000
    STA $4302
    STZ $4304
    LDA #$0220
    STA $4305    ; Transfer 544 bytes
    SEP #$20
    LDA #$01
    STA $420B
    
    ; Wait for DMA
    WAI
    
    ; Enable screen
    LDA #$0F     ; Screen on, brightness = 15
    STA $2100    ; INIDISP
    LDA #$01     ; Enable BG1
    STA $212C    ; TM
    
    ; Enable NMI
    LDA #$81
    STA $4200    ; Enable NMI, auto-joypad read
    
    CLI          ; Enable interrupts
    
    JMP main_loop
```

## Validation Rules

### Hardware Requirements

1. **Mode Switch: Must switch from emulation mode to native mode using XCE instruction
2. **Stack Initialization: Stack pointer must be set to valid WRAM address ($01FF recommended)
3. **Direct Page: Direct page register must be initialized
4. **Force Blank: Must enable force blank before PPU initialization
5. **DMA Timing: DMA transfers must complete before accessing target memory
6. **Register Writes: PPU registers must be written in correct order
7. **NMI Enable: NMI must be enabled after initialization complete

### Failure Modes

* **Missing Mode Switch: CPU remains in emulation mode, limited to 64KB address space
* **Uninitialized Stack: Stack operations corrupt memory
* **VRAM Access During Rendering: Visual corruption, incorrect tiles
* **DMA During Active Rendering: Data corruption, visual glitches
* **Missing Force Blank: PPU may be in unknown state during initialization

## Cross-References

- Related Fundamentals: 1.2 (65816 CPU Fundamentals), 1.3 (Memory Fundamentals)
- Related Advanced Fundamentals: 2.1 (CPU Timing), 2.2 (NMI & VBlank Discipline)
- Related Core Concepts: 3.1 (The Game Loop)
