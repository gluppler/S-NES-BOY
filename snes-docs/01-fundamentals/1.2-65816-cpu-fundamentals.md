# 1.2 65816 CPU Fundamentals

## System Applicability

**This document applies to:
- ✅ **SNES: Primary focus (Ricoh 5A22 CPU, 65816 variant)
- ❌ **NES: Does not apply (NES uses 6502 CPU - see NES-specific documentation)

## Physical Hardware Overview

The SNES uses a **Ricoh 5A22**, a 65816 variant. The CPU operates at:
* **NTSC: 3.579545 MHz (21.477272 MHz master clock ÷ 6)
* **PAL: 3.546894 MHz (26.601712 MHz master clock ÷ 7.5)

The 65816 is a 16-bit processor with:
* 24-bit address bus (16 MB addressable)
* 8-bit or 16-bit data bus (selectable)
* 8-bit or 16-bit accumulator (A, selectable)
* 8-bit or 16-bit index registers (X, Y, selectable)
* 16-bit stack pointer (SP, points to WRAM)
* 24-bit program counter (PC, bank + address)
* 8-bit status register (P: N V M X D I Z C)
* 8-bit data bank register (DBR)
* 8-bit program bank register (PBR)
* 16-bit direct page register (DP)

## SNES Terminology Definitions

* **Accumulator (A): Primary arithmetic/logic register (8-bit or 16-bit)
* **Index Registers (X, Y): Used for indexing memory and loops (8-bit or 16-bit)
* **Stack Pointer (SP): Points to WRAM (16-bit, can be anywhere in WRAM)
* **Status Register (P): Flags (N=Negative, V=Overflow, M=Memory, X=Index, D=Decimal, I=Interrupt, Z=Zero, C=Carry)
* **Native Mode: Full 65816 mode with 16-bit registers and new instructions
* **Emulation Mode: 6502-compatible mode (8-bit registers, limited addressing)
* **Direct Page: 64KB page for fast addressing (similar to zero page on 6502)
* **Bank: 64KB address space (256 banks total, $00-$FF)
* **Addressing Mode: How an instruction determines its operand address

## Core Rules and Invariants

### Registers

* **A: Accumulator, 8-bit or 16-bit (controlled by M flag)
* **X, Y: Index registers, 8-bit or 16-bit (controlled by X flag)
* **SP: Stack pointer, 16-bit, points to WRAM
* **PC: Program counter, 24-bit (8-bit bank + 16-bit address)
* **P: Status register, updated by most instructions
* **DBR: Data bank register, used for absolute long addressing
* **PBR: Program bank register, current code bank
* **DP: Direct page register, base address for direct page addressing

### CPU Modes

* **Native Mode: Full 65816 capabilities
  - 16-bit A, X, Y registers (default)
  - New addressing modes (absolute long, direct page, etc.)
  - New instructions (PEA, PER, MVN, MVP, etc.)
* **Emulation Mode: 6502 compatibility
  - 8-bit A, X, Y registers (fixed)
  - Stack fixed at $0100-$01FF
  - Limited to 64KB address space
  - 6502 instruction set only

### Addressing Modes

* **Immediate: `LDA #$42` (8-bit) or `LDA #$1234` (16-bit)
* **Direct Page: `LDA $42` (operand is DP + $42)
* **Direct Page,X: `LDA $42,X` (operand is DP + $42 + X)
* **Absolute: `LDA $1234` (operand is address in current data bank)
* **Absolute,X: `LDA $1234,X` (operand is $1234 + X)
* **Absolute Long: `LDA $123456` (24-bit address, bank + address)
* **Absolute Long,X: `LDA $123456,X` (24-bit address + X)
* **Indirect: `JMP ($1234)` (16-bit address from memory)
* **Indirect Long: `JMP [$1234]` (24-bit address from memory)
* **Stack Relative: `LDA $42,S` (operand is SP + $42)
* **Stack Relative Indirect Indexed: `LDA ($42,S),Y`

### Instruction Categories

* **Load/Store: LDA, LDX, LDY, STA, STX, STY, STZ
* **Arithmetic: ADC, SBC, INC, DEC, INX, DEX, INY, DEY
* **Logic: AND, ORA, EOR, ASL, LSR, ROL, ROR
* **Branches: BCC, BCS, BEQ, BMI, BNE, BPL, BVC, BVS, BRA, BRL
* **Jumps: JMP (absolute/indirect/long), JSR (absolute/long), RTS, RTL
* **Stack: PHA, PHX, PHY, PHP, PLA, PLX, PLY, PLP, PEA, PEI, PER
* **Flags: CLC, SEC, CLI, SEI, CLV, CLD, SED, XCE
* **Mode: REP, SEP (set/clear status flags)
* **Transfer: TAX, TAY, TXA, TYA, TXS, TSX, TCD, TDC, TCS, TSC, XBA
* **Block Move: MVN, MVP (copy memory blocks)
* **Misc: NOP, BRK, RTI, WAI, STP

## Minimal Correct Usage Example

```asm
; Switch to native mode
REP #$38     ; Native mode, clear decimal, clear accumulator width
XCE          ; Switch from emulation to native mode

; Set 8-bit mode
SEP #$30     ; 8-bit A, X, Y (M=1, X=1)

; Direct page usage
LDA #$00
TCD          ; Set direct page to $0000
LDA #$10
STA $00      ; Store to direct page ($0000)

; 16-bit mode
REP #$20     ; 16-bit accumulator
LDA #$1234   ; Load 16-bit value
STA $00      ; Store 16-bit value

; Absolute long addressing
LDA $C01234  ; Load from bank $C0, address $1234

; Block move
REP #$30     ; 16-bit A, X, Y
LDX #$0000   ; Source address
LDY #$1000   ; Destination address
LDA #$00FF   ; Count (256 bytes)
MVN $00,$00  ; Move from bank $00 to bank $00
```

## Gold Standard Example

```asm
; Complete 65816 initialization and usage example
reset:
    ; Start in emulation mode (default)
    SEI          ; Disable interrupts
    CLD          ; Clear decimal mode
    
    ; Switch to native mode
    REP #$38     ; Set native mode flags
                 ; Bit 4 (M) = 0: 16-bit accumulator
                 ; Bit 5 (X) = 0: 16-bit index registers
                 ; Bit 3 (D) = 0: Clear decimal mode
    XCE          ; Switch to native mode
    
    ; Initialize stack
    LDA #$01FF
    TCS          ; Stack pointer = $01FF
    
    ; Initialize direct page
    LDA #$0000
    TCD          ; Direct page = $0000
    
    ; Set 8-bit mode for most operations
    SEP #$30     ; 8-bit A, X, Y
                 ; M=1: 8-bit accumulator
                 ; X=1: 8-bit index registers
    
    ; Example: 8-bit operations
    LDA #$42
    STA $00      ; Store to direct page
    LDX #$05
    LDA $00,X    ; Load from direct page indexed
    
    ; Switch to 16-bit for math
    REP #$20     ; 16-bit accumulator
    LDA #$1234
    CLC
    ADC #$5678
    STA $00      ; Store 16-bit result
    
    ; Switch back to 8-bit
    SEP #$20     ; 8-bit accumulator
    
    ; Absolute long addressing
    LDA $C01234  ; Load from bank $C0, address $1234
    STA $C05678  ; Store to bank $C0, address $5678
    
    ; Block move example
    REP #$30     ; 16-bit A, X, Y
    LDX #$0000   ; Source address
    LDY #$1000   ; Destination address
    LDA #$00FF   ; Count - 1 (256 bytes)
    MVN $00,$00  ; Move from bank $00 to bank $00
                 ; X and Y auto-increment, A decrements
    
    ; Return to 8-bit mode
    SEP #$30
    
    JMP main_loop
```

## Validation Rules

### Mode Switching

1. **XCE Instruction: Must be executed to switch from emulation to native mode
2. **REP/SEP Usage: Must use REP/SEP to control register widths
3. **Flag State: M and X flags control accumulator and index register widths
4. **Stack in Native Mode: Stack can be anywhere in WRAM (not fixed at $0100-$01FF)

### Register Width Rules

1. **M Flag: 0 = 16-bit accumulator, 1 = 8-bit accumulator
2. **X Flag: 0 = 16-bit index registers, 1 = 8-bit index registers
3. **Width Consistency: Operations must match register width
4. **Flag Preservation: REP/SEP only affect specified flags

### Addressing Rules

1. **Direct Page: Must be set with TCD before using direct page addressing
2. **Bank Registers: DBR and PBR control bank addressing
3. **Absolute Long: Use when crossing bank boundaries
4. **Stack Relative: Valid only in native mode

### Failure Modes

* **Missing Mode Switch: CPU remains in emulation mode, limited functionality
* **Wrong Register Width: Data corruption, incorrect calculations
* **Uninitialized Direct Page: Direct page addressing accesses wrong memory
* **Bank Mismatch: Absolute addressing uses wrong bank
* **Stack Overflow: Stack pointer wraps or exceeds WRAM bounds

## Cross-References

- Related Fundamentals: 1.1 (SNES System Overview), 1.3 (Memory Fundamentals)
- Related Advanced Fundamentals: 2.1 (CPU Timing), 2.2 (NMI & VBlank Discipline)
- Related Core Concepts: 3.1 (The Game Loop)
