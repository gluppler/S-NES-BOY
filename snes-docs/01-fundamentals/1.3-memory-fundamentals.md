# 1.3 SNES Memory Fundamentals

## System Applicability

**This document applies to:**
- ✅ **SNES: Primary focus
- ❌ **NES: Does not apply (NES has different memory architecture - 16-bit address bus, different memory map)

## Physical Hardware Overview

The SNES CPU (65816) has a 24-bit address bus, providing 16 MB ($000000–$FFFFFF) of addressable space. This space is divided into:

* **WRAM: 128 KB of work RAM (banks $7E-$7F)
* **ROM: Cartridge ROM (banks $00-$7F for LoROM, $C0-$FF for HiROM)
* **I/O Registers: PPU, APU, DMA, and other hardware registers
* **Cartridge Space: ROM, SRAM, enhancement chips

The PPU has its own address space separate from the CPU bus.

## SNES Terminology Definitions

* **CPU Memory Map: The 16 MB address space visible to the CPU
* **PPU Memory Map: The address space visible to the PPU (VRAM, CGRAM, OAM)
* **Direct Page: 64KB page for fast addressing (similar to zero page on 6502)
* **Bank: 64KB address space (256 banks total, $00-$FF)
* **WRAM: Work RAM, 128 KB at banks $7E-$7F
* **VRAM: Video RAM, 64 KB PPU-accessible
* **CGRAM: Color Generator RAM, 512 bytes for palettes
* **OAM: Object Attribute Memory, 544 bytes for sprites
* **LoROM: ROM mapping mode (banks $00-$7F, $80-$FF)
* **HiROM: ROM mapping mode (banks $C0-$FF)

## Core Rules and Invariants

### CPU Memory Map ($000000–$FFFFFF)

| Address Range | Size | Description | Notes |
|--------------|------|-------------|-------|
| $000000–$1FFFFF | 2 MB | LoROM Cartridge | Banks $00-$7F |
| $200000–$3FFFFF | 2 MB | LoROM Cartridge | Banks $80-$FF |
| $400000–$7FFFFF | 4 MB | HiROM Cartridge | Banks $C0-$FF |
| $7E0000–$7FFFFF | 128 KB | WRAM | Work RAM |
| $800000–$FFFFFF | 8 MB | I/O, Expansion | PPU, APU, DMA registers |

### Direct Page Philosophy

* Direct page (DP register) provides fast addressing (similar to zero page)
* Critical variables should use direct page addressing
* Direct page can be set anywhere in WRAM
* Direct page addressing is faster than absolute addressing

### WRAM Usage

* WRAM is at banks $7E-$7F ($7E0000–$7FFFFF)
* 128 KB total (larger than NES 2 KB RAM)
* Can be used for game state, entity data, buffers
* Accessible via direct page or absolute addressing

## Minimal Correct Usage Example

```asm
; Direct page usage
LDA #$0000
TCD          ; Set direct page to $0000
LDA #$42
STA $00      ; Store to direct page ($0000)

; WRAM usage
LDA #$42
STA $7E0000  ; Store to WRAM bank $7E

; Absolute long addressing
LDA $C01234  ; Load from ROM bank $C0, address $1234

; Pointer usage
LDA #<data_table
STA $00      ; Pointer low byte
LDA #>data_table
STA $01      ; Pointer high byte
LDA #^data_table
STA $02      ; Pointer bank byte
LDY #0
LDA [$00],Y  ; Load from pointer (24-bit address)
```

## Gold Standard Example

```asm
; Complete SNES memory usage example
reset:
    ; Initialize direct page
    REP #$20     ; 16-bit accumulator
    LDA #$0000
    TCD          ; Direct page = $0000
    
    ; Set 8-bit mode
    SEP #$20     ; 8-bit accumulator
    
    ; Direct page variables
    LDA #0
    STA frame_counter    ; Direct page $00
    STA frame_ready      ; Direct page $01
    STA scroll_x         ; Direct page $02
    STA scroll_y         ; Direct page $03
    
    ; WRAM usage (game state)
    LDA #1
    STA $7E0300          ; Game state in WRAM
    LDA #3
    STA $7E0301          ; Lives in WRAM
    
    ; Set up 24-bit pointer
    REP #$20
    LDA #<data_table
    STA $00              ; Pointer low byte
    LDA #>data_table
    STA $01              ; Pointer high byte
    SEP #$20
    LDA #^data_table
    STA $02              ; Pointer bank byte
    
    ; Access data via pointer
    LDY #0
    LDA [$00],Y          ; Load from 24-bit pointer
    
    ; Stack operations (WRAM-based)
    PHA                  ; Push accumulator
    PHX                  ; Push X register
    PHY                  ; Push Y register
    
    ; Use registers
    LDA #$42
    TAX                  ; Transfer to X
    TXA                  ; Transfer back
    
    ; Restore registers
    PLY                  ; Restore Y
    PLX                  ; Restore X
    PLA                  ; Restore A
    
    ; Access I/O registers
    LDA #$8F
    STA $2100            ; INIDISP (force blank)
    LDA #$01
    STA $212C            ; TM (main screen designation)
    
    RTS

; Data in ROM
data_table:
    .byte $01, $02, $03, $04
```

## Validation Rules

### Memory Access Rules

1. **Direct Page Setup: Direct page must be initialized with TCD before use
2. **WRAM Access: WRAM is at banks $7E-$7F, use absolute long addressing
3. **Bank Registers: DBR and PBR control bank addressing
4. **Pointer Setup: 24-bit pointers require 3 bytes (low, high, bank)
5. **Stack Location: Stack can be anywhere in WRAM (not fixed)
6. **I/O Register Access: I/O registers at $2100-$21FF, $4200-$43FF
7. **ROM Access: Use absolute long addressing for ROM access

### Addressing Mode Rules

1. **Direct Page: Use for frequently accessed variables
2. **Absolute Long: Use when crossing bank boundaries
3. **Absolute: Uses current data bank (DBR register)
4. **Indirect Long: Use for 24-bit pointers
5. **Stack Relative: Available in native mode

### Failure Modes

* **Uninitialized Direct Page: Direct page addressing accesses wrong memory
* **Bank Mismatch: Absolute addressing uses wrong bank
* **Pointer Corruption: 24-bit pointer missing bank byte causes wrong address
* **WRAM Overflow: Writing beyond WRAM bounds corrupts memory
* **I/O Register Timing: Accessing I/O registers at wrong time causes corruption

## Explicit Non-Goals

This section does not cover:
* Detailed PPU memory layout (see 1.4)
* Cartridge mapper details
* Timing-critical memory access
* Data-oriented design patterns
* Memory map cheatsheet (see 4.3)

## Cross-References

- Related Fundamentals: 1.1 (SNES System Overview), 1.2 (65816 CPU)
- Related Advanced Fundamentals: 2.1 (CPU Timing)
- Related Core Concepts: 3.2 (Data-Oriented Design)
- Related Cheatsheets: 4.3 (Memory Cheatsheets)
