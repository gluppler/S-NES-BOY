# 1.4 SNES PPU Fundamentals

## System Applicability

**This document applies to:**
- ✅ **SNES: Primary focus
- ❌ **NES: Does not apply (NES uses different PPU architecture)

## Physical Hardware Overview

The SNES PPU consists of two chips (PPU1 and PPU2) operating at approximately 21.477 MHz (NTSC). The PPU has:

* 64 KB VRAM (Video RAM)
* 512 bytes CGRAM (Color Generator RAM, palettes)
* 544 bytes OAM (Object Attribute Memory, sprites)
* Multiple background layers (up to 4)
* Mode 7 special effects
* Enhanced sprite capabilities

The CPU communicates with the PPU through memory-mapped registers at $2100–$213F.

## SNES Terminology Definitions

* **Background Layer: One of up to 4 background layers
* **Mode 0–7: Background rendering modes (different layer configurations)
* **Tile: 8×8 or 16×16 pixel pattern
* **VRAM: Video RAM, 64 KB for tiles and name tables
* **CGRAM: Color Generator RAM, 512 bytes (256 colors, 15-bit RGB)
* **OAM: Object Attribute Memory, 544 bytes defining up to 128 sprites
* **Sprite: 8×8 to 64×64 pixel object with rotation/scaling
* **HDMA: H-Blank DMA for per-scanline updates
* **VBlank: Period when PPU is not rendering (safe for VRAM access)

## Core Rules and Invariants

### Background Modes

* **Mode 0: 4 layers of 8×8 tiles, 4 colors per tile
* **Mode 1: 3 layers + Mode 7, 16 colors per tile
* **Mode 2: 2 layers, 16 colors per tile
* **Mode 3: 2 layers, 256 colors per tile (Mode 7 available)
* **Mode 4: 2 layers, 256 colors per tile
* **Mode 5: 2 layers, 16 colors per tile (high resolution)
* **Mode 6: 1 layer + Mode 7 (high resolution)
* **Mode 7: 1 layer with rotation/scaling

### VRAM Organization

* VRAM is 64 KB (vs NES 2 KB)
* Can store tiles, name tables, and other graphics data
* Access via $2116/$2117 (VMADDL/VMADDH) and $2118/$2119 (VMDATAL/VMDATAH)
* Must access during VBlank or forced blanking

### Sprites

* Up to 128 sprites (vs NES 64)
* Sprites can be 8×8 to 64×64 pixels
* Support rotation and scaling
* Maximum 32 sprites per scanline (hardware limit)

## Minimal Correct Usage Example

```asm
; Set PPU address to VRAM
LDA #$00
STA $2116    ; VMADDL - VRAM address low
LDA #$00
STA $2117    ; VMADDH - VRAM address high

; Write to VRAM
LDA #$01
STA $2118    ; VMDATAL - VRAM data low
LDA #$00
STA $2119    ; VMDATAH - VRAM data high

; Set CGRAM address
LDA #$00
STA $2121    ; CGADD - CGRAM address

; Write to CGRAM
LDA #$00
STA $2122    ; CGDATA - CGRAM data low
LDA #$00
STA $2122    ; CGDATA - CGRAM data high
```

## Gold Standard Example

```asm
; Complete SNES PPU usage example
load_palette:
    ; Set CGRAM address to $00
    LDA #$00
    STA $2121    ; CGADD
    
    ; Write palette data (256 colors, 15-bit RGB)
    LDX #0
    LDY #0
palette_loop:
    LDA palette_data_low,X
    STA $2122    ; CGDATA low byte
    LDA palette_data_high,X
    STA $2122    ; CGDATA high byte
    INX
    CPX #256     ; 256 colors
    BNE palette_loop
    
    RTS

load_background:
    ; Set VRAM address increment mode
    LDA #$80     ; Increment by 1 word
    STA $2115    ; VMAIN
    
    ; Set VRAM address to $0000
    LDA #$00
    STA $2116    ; VMADDL
    LDA #$00
    STA $2117    ; VMADDH
    
    ; Write tile data to VRAM
    LDX #0
vram_loop:
    LDA tile_data_low,X
    STA $2118    ; VMDATAL
    LDA tile_data_high,X
    STA $2119    ; VMDATAH
    INX
    CPX #32      ; 32 tiles (16 bytes each = 512 bytes)
    BNE vram_loop
    
    RTS

update_sprite:
    ; Update sprite in OAM
    ; Input: X = sprite index (0-127), A = attributes
    PHA
    
    ; Calculate OAM offset: sprite_index * 4
    TXA
    ASL
    ASL
    TAY
    
    ; Write sprite data
    LDA sprite_y,X
    STA $2102,Y  ; OAM low address
    LDA sprite_tile,X
    STA $2103,Y  ; OAM high address
    PLA
    STA sprite_attr,X
    
    RTS

palette_data_low:
    .byte $00, $00, $00, $00  ; Color 0-3 low bytes
    ; ... 256 colors total
palette_data_high:
    .byte $00, $00, $00, $00  ; Color 0-3 high bytes
    ; ... 256 colors total
```

## Validation Rules

### PPU Access Rules

1. **VBlank Access: VRAM/CGRAM writes must occur during VBlank or forced blanking
2. **Address Setup: Must set VRAM/CGRAM address before writing data
3. **Increment Mode: VMAIN controls VRAM address increment (1 byte or 1 word)
4. **OAM Access: OAM updates must use DMA or proper register sequence
5. **Register Order: PPU registers must be written in correct sequence
6. **Mode Selection: Background mode must be set before rendering

### Background and Sprite Rules

1. **Mode Selection: Choose appropriate mode for desired layer configuration
2. **VRAM Size: VRAM is 64 KB, plan tile and name table usage accordingly
3. **CGRAM Size: CGRAM is 512 bytes (256 colors), plan palette usage
4. **Sprite Limit: Maximum 32 sprites per scanline (hardware limit)
5. **Tile Size: Tiles can be 8×8 or 16×16 pixels depending on mode

### Failure Modes

* **VRAM Access During Rendering: Visual corruption, incorrect tiles
* **Wrong Address Setup: Writes to wrong VRAM location
* **Incorrect Increment Mode: VRAM address advances incorrectly
* **Sprite Overflow: More than 32 sprites per scanline causes flickering
* **Missing Mode Setup: Background mode not set, nothing renders
* **CGRAM Corruption: Palette data incorrect, wrong colors displayed

## Explicit Non-Goals

This section does not cover:
* Detailed background mode configurations
* Mode 7 rotation/scaling mathematics
* HDMA techniques
* Advanced sprite features (rotation, scaling)
* PPU register details (see 4.2)

## Cross-References

- Related Fundamentals: 1.1 (SNES System Overview), 1.3 (Memory)
- Related Advanced Fundamentals: 2.3 (PPU Rendering Rules)
- Related Core Concepts: 3.3 (Rendering Architecture)
- Related Cheatsheets: 4.2 (PPU Cheatsheets)
