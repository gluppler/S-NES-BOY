# 5.5 Audio Integration

## System Applicability

**This document applies to:
- ✅ **NES: Primary focus (FamiTone2 and direct APU control)
- ✅ **: Fully compatible (same APU, plus expansion audio support)
- ❌ **SNES: Does not apply (SNES uses SPC700 audio processor with different architecture and tools)

**-Specific Notes:
-  supports expansion audio chips (VRC6, VRC7, FDS audio)
- Expansion audio requires mapper-specific integration
- FamiTone2 does not support expansion audio (direct APU control required)

**Note: SNES uses SPC700 audio processor with different tools (SPC700 assembler, different music formats). This document covers NES/ audio integration only.

## FamiTone2 Update Loop

**Pattern: Use FamiTone2 music engine (or similar) to play music and sound effects. Update the engine once per frame in the main loop.

**Implementation:
```asm
; FamiTone2 integration
; Include FamiTone2 library
.include "famitone2.asm"

; Music data (ROM)
music_data:
    .incbin "music.ftm"

; Sound effect data (ROM)
sfx_data:
    .incbin "sfx.ftm"

; Initialize audio
init_audio:
    ; Disable all channels
    LDA #0
    STA $4015
    
    ; Initialize FamiTone2
    LDA #<music_data
    STA FT_MUSIC_PTR
    LDA #>music_data
    STA FT_MUSIC_PTR+1
    
    LDA #<sfx_data
    STA FT_SFX_PTR
    LDA #>sfx_data
    STA FT_SFX_PTR+1
    
    ; Initialize FamiTone2
    JSR FamiTone2Init
    
    ; Enable channels
    LDA #%00001111  ; Enable pulse 1, pulse 2, triangle, noise
    STA $4015
    
    ; Initialize frame counter (5-step mode, no IRQ)
    LDA #%11000000
    STA $4017
    
    RTS

; Update audio (call once per frame)
update_audio:
    ; Update FamiTone2
    JSR FamiTone2Update
    
    RTS

; Play music
play_music:
    ; A = song index
    JSR FamiTone2MusicPlay
    RTS

; Play sound effect
play_sfx:
    ; A = sound effect index
    ; X = channel (0 = pulse 1, 1 = pulse 2, 2 = triangle, 3 = noise)
    JSR FamiTone2SfxPlay
    RTS

; Stop music
stop_music:
    JSR FamiTone2MusicStop
    RTS
```

## Music vs SFX Priority

**Pattern: Prioritize sound effects over music when channels conflict. Reserve specific channels for SFX and others for music.

**Channel Allocation:
- **Pulse 1: Sound effects (priority)
- **Pulse 2: Music
- **Triangle: Music (bass)
- **Noise: Sound effects (priority)

**Implementation:
```asm
; Audio priority system
sfx_playing = $40    ; Zero page: SFX active flags (bit per channel)
music_channels = $41 ; Zero page: Music channel mask

; Initialize audio priority
init_audio_priority:
    LDA #0
    STA sfx_playing
    LDA #%00001110   ; Music uses pulse 2, triangle, noise
    STA music_channels
    RTS

; Play sound effect with priority
play_sfx_priority:
    ; A = sound effect index
    ; X = channel (0 = pulse 1, 1 = pulse 2, 2 = triangle, 3 = noise)
    
    ; Check if channel is reserved for music
    TXA
    TAY
    LDA bit_table,Y
    AND music_channels
    BNE sfx_blocked  ; Channel reserved for music
    
    ; Check if SFX already playing on this channel
    LDA bit_table,Y
    AND sfx_playing
    BNE sfx_blocked  ; SFX already playing
    
    ; Play SFX
    JSR FamiTone2SfxPlay
    
    ; Mark channel as SFX
    LDA bit_table,Y
    ORA sfx_playing
    STA sfx_playing
    
    RTS
    
sfx_blocked:
    ; SFX blocked, try alternative channel
    ; (e.g., try pulse 1 if pulse 2 is busy)
    RTS

; Update audio with priority
update_audio_priority:
    ; Update FamiTone2
    JSR FamiTone2Update
    
    ; Check if SFX finished
    LDX #0
sfx_check_loop:
    LDA bit_table,X
    AND sfx_playing
    BEQ sfx_check_next
    
    ; Check if SFX channel is still active
    ; (FamiTone2 sets channel enable when SFX is playing)
    TXA
    TAY
    LDA channel_enable_table,Y
    TAY
    LDA $4015
    AND channel_bit_table,Y
    BNE sfx_check_next  ; Channel still active
    
    ; SFX finished, clear flag
    LDA bit_table,X
    EOR #$FF
    AND sfx_playing
    STA sfx_playing
    
sfx_check_next:
    INX
    CPX #4
    BNE sfx_check_loop
    
    RTS

; Bit tables
bit_table:
    .byte %00000001, %00000010, %00000100, %00001000
channel_enable_table:
    .byte 3, 4, 5, 6  ; Pulse 1, Pulse 2, Triangle, Noise bits in $4015
channel_bit_table:
    .byte %00001000, %00010000, %00100000, %01000000
```

## Simple Direct APU Control

**Pattern: For simple games, directly control APU registers without a music engine. Use lookup tables for notes and simple patterns.

**Implementation:
```asm
; Simple note table (periods for common notes)
note_table:
    .word $0C00  ; C4
    .word $0B00  ; D4
    .word $0A00  ; E4
    .word $0900  ; F4
    .word $0800  ; G4
    .word $0700  ; A4
    .word $0600  ; B4
    .word $0500  ; C5

; Play note on pulse 1
play_note:
    ; A = note index (0-7)
    ASL A           ; Multiply by 2 (word table)
    TAY
    
    ; Set period
    LDA note_table,Y
    STA $4002       ; Period low
    LDA note_table+1,Y
    STA $4003       ; Period high, length counter
    
    ; Enable channel and set volume
    LDA #%10001111  ; Duty 50%, volume 15, constant volume
    STA $4000
    
    ; Enable pulse 1
    LDA $4015
    ORA #%00000001
    STA $4015
    
    RTS

; Simple sound effect (jump)
play_jump_sfx:
    ; Set pulse 1 to high frequency
    LDA #<$0800
    STA $4002
    LDA #>$0800
    STA $4003
    
    ; Set volume envelope (decay)
    LDA #%10011111  ; Duty 50%, volume 15, envelope
    STA $4000
    
    ; Enable pulse 1
    LDA $4015
    ORA #%00000001
    STA $4015
    
    RTS
```

## Cross-References

- Related Fundamentals: 1.1 (NES System Overview)
- Related Advanced Fundamentals: 2.5 (Audio Fundamentals), 2.1 (CPU Timing & Cycles)
- Related Core Concepts: 3.1 (Game Loop), 3.4 (Input → State → Output)
- Related Cheatsheets: 4.5 (Audio Cheatsheets)
