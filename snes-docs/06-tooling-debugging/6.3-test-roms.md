# 6.3 Test ROMs

## System Applicability

**This document applies to:
- ✅ **NES: Primary focus
- ✅ **: Fully compatible (same test ROMs)
- ⚠️ **SNES: Partially applicable (SNES has different test ROMs for 65816 CPU and SNES-specific hardware)

**Note: SNES requires different test ROMs for 65816 CPU and SNES-specific hardware (PPU, SPC700). This document covers NES/ test ROMs only.

## CPU Tests

**Blargg's CPU Tests: Comprehensive 6502 instruction tests

**Usage:
```bash
# Download from https://github.com/blargg/nes_ntsc_tests
# Run in emulator
mesen cpu_test.nes
```

**Tests included:
- All addressing modes
- All instructions
- Flag behavior
- Branch timing
- Page boundary crossings

**Expected result: Screen shows "Pass" or specific test name if failure

## PPU Tests

**PPU VBlank / NMI Test: Verifies NMI timing and VBlank detection

**Usage:
```bash
# Run in emulator
mesen ppu_vbl_nmi.nes
```

**What it tests:
- NMI fires at correct scanline (241)
- VBlank flag ($2002 bit 7) behavior
- PPU register timing

**Expected result: Green screen = pass, red screen = fail

**PPU Sprite Tests: Verifies sprite rendering

**Tests included:
- Sprite 0 hit detection
- Sprite overflow flag
- 8 sprite per scanline limit
- Sprite priority

## APU Tests

**APU Frame Counter Test: Verifies frame counter timing

**Usage:
```bash
# Run in emulator
mesen apu_test.nes
```

**What it tests:
- Frame counter modes (4-step, 5-step)
- Frame counter IRQ
- Channel timing

**Expected result: Audio output matches expected pattern

## Creating Custom Test ROMs

**Minimal test ROM structure:
```asm
.segment "HEADER"
    .byte "NES", $1A
    .byte 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0

.segment "VECTORS"
    .addr nmi, reset, irq

.segment "CODE"
reset:
    SEI
    CLD
    LDX #$FF
    TXS
    
    ; Initialize PPU
    LDA #0
    STA $2000
    STA $2001
    
    ; Wait for VBlank
    BIT $2002
vblank_wait:
    BIT $2002
    BPL vblank_wait
    
    ; Run test
    JSR test_function
    
    ; Set result (green = pass, red = fail)
    LDA test_result
    BEQ test_pass
    
    ; Test failed (red)
    LDA #$3F
    STA $2006
    LDA #$00
    STA $2006
    LDA #$16  ; Red
    STA $2007
    JMP test_done
    
test_pass:
    ; Test passed (green)
    LDA #$3F
    STA $2006
    LDA #$00
    STA $2006
    LDA #$2A  ; Green
    STA $2007
    
test_done:
    JMP test_done  ; Infinite loop

nmi:
    RTI

irq:
    RTI

; Test function
test_function:
    ; Perform test
    LDA #1
    STA test_value
    LDA test_value
    CMP #1
    BNE test_fail
    
    ; Test passed
    LDA #0
    STA test_result
    RTS
    
test_fail:
    ; Test failed
    LDA #1
    STA test_result
    RTS

test_value = $00
test_result = $01
```

## Test ROM Resources

**Blargg's NES Test Roms:
- CPU tests
- APU tests
- PPU tests
- https://github.com/blargg/nes_ntsc_tests

**NES Test Suite:
- Comprehensive test collection
- https://github.com/pinobatch/nes-test-roms

**Custom Test Roms:
- Create your own for specific features
- Use minimal structure above

## Running Tests

**In Mesen2:
1. File → Open ROM
2. Select test ROM
3. Observe result (screen color or text)

**Automated Testing:
```bash
# Run test ROM and capture result
mesen --test test_rom.nes > test_output.txt
```

## Interpreting Results

**Green screen: Test passed
**Red screen: Test failed
**Text output: Specific test name or error message
**Audio output: For APU tests, listen for expected patterns

## Cross-References

- Related Fundamentals: 1.2 (6502 CPU Fundamentals), 1.4 (PPU Fundamentals)
- Related Advanced Fundamentals: 2.1 (CPU Timing), 2.5 (Audio Fundamentals)
- Related Tooling: 6.2 (Emulators & Debuggers)
